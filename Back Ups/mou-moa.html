<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>LILAC MOUs & MOAs</title>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Add these libraries for file to image conversion -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": {
                            DEFAULT: "#137fec",
                            "50": "#e8f2fe",
                            "100": "#d1e6fd",
                            "200": "#a2cbfb",
                            "300": "#74b1f9",
                            "400": "#4596f7",
                            "500": "#137fec",
                            "600": "#0f66bc",
                            "700": "#0c4c8d",
                            "800": "#08335d",
                            "900": "#04192e"
                        },
                        "background-light": "#f1f5f9",
                        "background-dark": "#0f172a",
                        "card-light": "#ffffff",
                        "card-dark": "#1e293b",
                        "text-light": "#0f172a",
                        "text-dark": "#e2e8f0",
                        "text-muted-light": "#64748b",
                        "text-muted-dark": "#94a3b8",
                        "border-light": "#e2e8f0",
                        "border-dark": "#334155",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "0.75rem",
                        "xl": "1rem",
                        "full": "9999px"
                    },
                    boxShadow: {
                        'soft': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05)',
                    }
                },
            },
        }
    </script>
<style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .material-symbols-outlined.filled {
            font-variation-settings: 'FILL' 1;
        }
        .dark .chartjs-grid-color {
            color: theme('colors.border-dark');
        }
        .chartjs-grid-color {
            color: theme('colors.border-light');
        }
        .dark .chartjs-tick-color {
            color: theme('colors.text-muted-dark');
        }
        .chartjs-tick-color {
            color: theme('colors.text-muted-light');
        }
        .dark .chartjs-legend-color {
            color: theme('colors.text-dark');
        }
        .chartjs-legend-color {
            color: theme('colors.text-light');
        }
        .sidebar-collapsed .sidebar-text {
            display: none;
        }
        .sidebar-collapsed .sidebar-logo-text {
            display: none;
        }
        .sidebar-collapsed .sidebar {
            width: 5rem;
        }
        .sidebar-expanded .sidebar {
            width: 16rem;
        }
        .sidebar-collapsed .sidebar-profile-info {
            display: none;
        }
        .sidebar-collapsed .sidebar-profile-picture {
            display: none;
        }
        /* Add styles for expanded sidebar */
        .sidebar-expanded .sidebar-profile-picture {
            display: block;
        }
        .sidebar-expanded .sidebar-profile-info {
            display: block;
        }
        .sidebar-collapsed main {
            margin-left: 2rem;
        }
        .sidebar-expanded main {
            margin-left: 0 !important;
        }
        .sidebar-expanded .main-content {
            padding-left: 0;
        }
        .sidebar-collapsed .main-content {
            padding-left: 0;
        }
        .sidebar-collapsed .sidebar-toggle-icon-open {
            display: none;
        }
        .sidebar-collapsed .sidebar-toggle-icon-closed {
            display: block;
        }
        .sidebar-toggle-icon-closed {
            display: none;
        }
        .sidebar-collapsed .sidebar-nav-link {
            justify-content: center;
        }
        .sidebar-collapsed .sidebar-toggle-container {
            justify-content: center;
        }
        .sidebar-collapsed .profile-container {
            justify-content: center;
        }
        /* Clickable table rows */
        tbody tr {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background-color: rgba(19, 127, 236, 0.05) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .dark tbody tr:hover {
            background-color: rgba(19, 127, 236, 0.1) !important;
        }

        /* Prevent hover effects on buttons and checkboxes */
        tbody tr:hover td button,
        tbody tr:hover td input[type="checkbox"] {
            pointer-events: auto;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-light dark:text-text-dark">
<div class="flex h-screen sidebar-collapsed" id="app-container">
<aside class="sidebar bg-card-light dark:bg-card-dark border-r border-border-light dark:border-border-dark flex flex-col">
<div class="flex items-center justify-start px-4 h-20 border-b border-border-light dark:border-border-dark">
<div class="flex items-center gap-3">
<img alt="CPU LILAC Logo" class="h-11 w-11" src="assets/images/cpu-logo.svg.png" width="32" height="32"/>
<h1 class="text-xl font-bold text-text-light dark:text-text-dark sidebar-logo-text hidden">LILAC</h1>
</div>
</div>
<nav class="flex-1 px-4 py-6 space-y-2">
<a class="flex items-center justify-center gap-3 px-4 py-2.5 rounded-lg text-text-muted-light dark:text-text-muted-dark hover:bg-gray-100 dark:hover:bg-background-dark hover:text-text-light dark:hover:text-text-dark transition-colors duration-200 sidebar-nav-link" href="dashboard.html">
<span class="material-symbols-outlined">dashboard</span>
<span class="sidebar-text hidden">Dashboard</span>
</a>
<a class="flex items-center justify-center gap-3 px-4 py-2.5 rounded-lg text-text-muted-light dark:text-text-muted-dark hover:bg-gray-100 dark:hover:bg-background-dark hover:text-text-light dark:hover:text-text-dark transition-colors duration-200 sidebar-nav-link" href="awards.html">
<span class="material-symbols-outlined">emoji_events</span>
<span class="sidebar-text hidden">Awards Progress</span>
</a>
<a class="flex items-center justify-center gap-3 px-4 py-2.5 rounded-lg text-text-muted-light dark:text-text-muted-dark hover:bg-gray-100 dark:hover:bg-background-dark hover:text-text-light dark:hover:text-text-dark transition-colors duration-200 sidebar-nav-link" href="events-activities.html">
<span class="material-symbols-outlined">event</span>
<span class="sidebar-text hidden">Events &amp; Activities</span>
</a>
<a class="flex items-center justify-center gap-3 px-4 py-2.5 rounded-lg text-text-muted-light dark:text-text-muted-dark hover:bg-gray-100 dark:hover:bg-background-dark hover:text-text-light dark:hover:text-text-dark transition-colors duration-200 sidebar-nav-link" href="scheduler.html">
<span class="material-symbols-outlined">calendar_today</span>
<span class="sidebar-text hidden">Scheduler</span>
</a>
<a class="flex items-center justify-center gap-3 px-4 py-2.5 rounded-lg bg-primary-50 dark:bg-primary-900/40 text-primary-600 dark:text-primary-300 font-semibold sidebar-nav-link" href="mou-moa.html">
<span class="material-symbols-outlined filled">handshake</span>
<span class="sidebar-text hidden">MOUs &amp; MOAs</span>
</a>
<a class="flex items-center justify-center gap-3 px-4 py-2.5 rounded-lg text-text-muted-light dark:text-text-muted-dark hover:bg-gray-100 dark:hover:bg-background-dark hover:text-text-light dark:hover:text-text-dark transition-colors duration-200 sidebar-nav-link" href="templates.html">
<span class="material-symbols-outlined">description</span>
<span class="sidebar-text hidden">Templates</span>
</a>
<a class="flex items-center justify-center gap-3 px-4 py-2.5 rounded-lg text-text-muted-light dark:text-text-muted-dark hover:bg-gray-100 dark:hover:bg-background-dark hover:text-text-light dark:hover:text-text-dark transition-colors duration-200 sidebar-nav-link" href="documents.html">
<span class="material-symbols-outlined">school</span>
<span class="sidebar-text hidden">Registrar Forms</span>
</a>
</nav>
<div class="px-4 py-4 border-t border-border-light dark:border-border-dark">
<div class="flex items-center justify-between profile-container">
<div class="flex items-center gap-3">
<div class="w-10 h-10 rounded-full bg-cover bg-center sidebar-profile-picture hidden" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuC23fvgOSZIK6K5vguUgvVeU1XYFfp1LB3d4zICMvW6bispRl-eHHfnOtSsvRU3MgvmOpSYMCZhcSBIksvjlEHtkGMxuCFsQkuT0suo2-O9n3py7mlzFFETXCOIfvLVGGUj1aaG8ENOeDXXy_ifek2uG3R3--ghDflKvuAm9vrceoK8doav0lNYVbLz1bnWy6REWcrCPuPZZ8upfPqShoQpSDjICl16zMEcRuHzjt05z9cFITLKPdZTfMF-1dLK-klh8UhjeDeE4Q7p");'></div>
<div class="sidebar-profile-info hidden">
<p class="font-semibold text-text-light dark:text-text-dark">Admin User</p>
<a class="text-sm text-primary-600 dark:text-primary-400 hover:underline" href="profile.html">View Profile</a>
</div>
</div>
<button class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-background-dark transition-colors" id="sidebar-toggle">
<span class="material-symbols-outlined sidebar-toggle-icon-open hidden">chevron_left</span>
<span class="material-symbols-outlined sidebar-toggle-icon-closed block">chevron_right</span>
</button>
</div>
</div>
</aside>
<main class="flex-1 overflow-y-auto">
<header class="sticky top-0 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm z-30 px-6 lg:px-8 py-4 border-b border-border-light dark:border-border-dark flex justify-between items-center h-20">
<h1 class="text-2xl font-bold text-text-light dark:text-text-dark">MOUs & MOAs</h1>
<div class="flex items-center gap-2">
<button class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-white/10 text-text-muted-light dark:text-text-muted-dark transition-colors duration-200">
<span class="material-symbols-outlined">search</span>
</button>
<div class="relative">
    <button id="notificationBtn" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-white/10 text-text-muted-light dark:text-text-muted-dark transition-colors duration-200 relative">
<span class="material-symbols-outlined">notifications</span>
        <!-- Notification Badge -->
        <span id="notificationBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
</button>
    
    <!-- Notification Dropdown -->
    <div id="notificationDropdown" class="absolute right-0 mt-2 w-96 bg-white dark:bg-background-dark rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-50 hidden max-h-96 overflow-y-auto">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Notifications</h3>
                <button id="markAllReadBtn" class="text-sm text-primary hover:text-primary/80 dark:text-primary-400 dark:hover:text-primary-300">
                    Mark all read
                </button>
            </div>
        </div>
        
        <div id="notificationList" class="max-h-80 overflow-y-auto">
            <!-- Notifications will be populated here -->
            <div id="noNotifications" class="p-6 text-center text-gray-500 dark:text-gray-400">
                <span class="material-symbols-outlined text-4xl mb-2 block">notifications_off</span>
                <p>No notifications</p>
            </div>
        </div>
        
        <div class="p-4 border-t border-gray-200 dark:border-gray-700">
            <button id="viewAllNotifications" class="w-full text-center text-sm text-primary hover:text-primary/80 dark:text-primary-400 dark:hover:text-primary-300">
                View all notifications
            </button>
        </div>
    </div>
</div>
<button class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-white/10 text-text-muted-light dark:text-text-muted-dark transition-colors duration-200" id="theme-toggle">
<span class="material-symbols-outlined dark:hidden">light_mode</span>
<span class="material-symbols-outlined hidden dark:inline">dark_mode</span>
</button>
</div>
</header>
<div class="pt-1 pr-2 pb-1 lg:pt-2 lg:pr-4 lg:pb-2 main-content">
<div class="p-3">
                <div class="flex flex-col md:flex-row md:items-center md:justify-end gap-4 mb-4">
                    <div class="flex items-center gap-2">
                        <div class="relative">
                            <button id="filterBtn" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-text-light bg-card-light border border-border-light rounded-lg hover:bg-gray-50 dark:bg-background-dark/50 dark:text-text-muted-dark dark:border-border-dark dark:hover:bg-card-dark">
                            <span class="material-symbols-outlined text-base">filter_list</span>
                                <span id="filterText">Filter</span>
                        </button>
                            
                            <!-- Advanced Filter Dropdown Menu -->
                            <div id="filterDropdown" class="absolute right-0 mt-2 w-80 bg-white dark:bg-background-dark rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-50 hidden max-h-96 overflow-y-auto">
                                <div class="py-2">
                                    <!-- Status Filter -->
                                    <div class="px-4 py-2 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Filter by Status</div>
                                    
                                    <button class="filter-option w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-between" data-filter="status" data-value="all">
                                        <span>All Status</span>
                                        <span class="filter-indicator hidden">✓</span>
                                    </button>
                                    
                                    <button class="filter-option w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-between" data-filter="status" data-value="Active">
                                        <span>Active</span>
                                        <span class="filter-indicator hidden">✓</span>
                                    </button>
                                    
                                    <button class="filter-option w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-between" data-filter="status" data-value="Expires Soon">
                                        <span>Expires Soon</span>
                                        <span class="filter-indicator hidden">✓</span>
                                    </button>
                                    
                                    <button class="filter-option w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-between" data-filter="status" data-value="Expired">
                                        <span>Expired</span>
                                        <span class="filter-indicator hidden">✓</span>
                                    </button>
                                    
                                    <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                                    
                                    <!-- Institution Filter -->
                                    <div class="px-4 py-2 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Filter by Institution</div>
                                    
                                    <div class="px-4 py-2">
                                        <input type="text" id="institutionFilter" placeholder="Search institution..." class="w-full px-3 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-background-dark text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                    </div>
                                    
                                    <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                                    
                                    <!-- Date Range Filters -->
                                    <div class="px-4 py-2 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Filter by Date Range</div>
                                    
                                    <div class="px-4 py-2 space-y-2">
                                        <div>
                                            <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Sign Date From</label>
                                            <input type="date" id="signDateFrom" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-background-dark text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-primary">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Sign Date To</label>
                                            <input type="date" id="signDateTo" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-background-dark text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-primary">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">End Date From</label>
                                            <input type="date" id="endDateFrom" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-background-dark text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-primary">
                                        </div>
                                        <div>
                                            <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">End Date To</label>
                                            <input type="date" id="endDateTo" class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-background-dark text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-primary">
                                        </div>
                                    </div>
                                    
                                    <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                                    
                                    <!-- Term Duration Filter -->
                                    <div class="px-4 py-2 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Filter by Term Duration</div>
                                    
                                    <button class="filter-option w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-between" data-filter="term" data-value="all">
                                        <span>All Terms</span>
                                        <span class="filter-indicator hidden">✓</span>
                                    </button>
                                    
                                    <button class="filter-option w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-between" data-filter="term" data-value="short">
                                        <span>Short Term (≤ 1 year)</span>
                                        <span class="filter-indicator hidden">✓</span>
                                    </button>
                                    
                                    <button class="filter-option w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-between" data-filter="term" data-value="medium">
                                        <span>Medium Term (1-3 years)</span>
                                        <span class="filter-indicator hidden">✓</span>
                                    </button>
                                    
                                    <button class="filter-option w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-between" data-filter="term" data-value="long">
                                        <span>Long Term (> 3 years)</span>
                                        <span class="filter-indicator hidden">✓</span>
                                    </button>
                                    
                                    <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                                    
                                    <button id="clearFilter" class="w-full text-left px-4 py-2 text-sm text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800">
                                        Clear All Filters
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="relative">
    <button id="sortBtn" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-text-light bg-card-light border border-border-light rounded-lg hover:bg-gray-50 dark:bg-background-dark/50 dark:text-text-muted-dark dark:border-border-dark dark:hover:bg-card-dark">
        <span class="material-symbols-outlined text-base">swap_vert</span>
        <span id="sortText">Sort</span>
    </button>
    
    <!-- Sort Dropdown Menu -->
    <div id="sortDropdown" class="absolute right-0 mt-2 w-56 bg-white dark:bg-background-dark rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-50 hidden">
        <div class="py-2">
            <div class="px-4 py-2 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Sort by</div>
            
            <button class="sort-option w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-between" data-sort="institution" data-direction="asc">
                <span>Institution (A-Z)</span>
                <span class="sort-indicator hidden">✓</span>
            </button>
            
            <button class="sort-option w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-between" data-sort="institution" data-direction="desc">
                <span>Institution (Z-A)</span>
                <span class="sort-indicator hidden">✓</span>
            </button>
            
            <button class="sort-option w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-between" data-sort="location" data-direction="asc">
                <span>Location (A-Z)</span>
                <span class="sort-indicator hidden">✓</span>
            </button>
            
            <button class="sort-option w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-between" data-sort="signDate" data-direction="desc">
                <span>Sign Date (Newest)</span>
                <span class="sort-indicator hidden">✓</span>
            </button>
            
            <button class="sort-option w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-between" data-sort="signDate" data-direction="asc">
                <span>Sign Date (Oldest)</span>
                <span class="sort-indicator hidden">✓</span>
            </button>
            
            <button class="sort-option w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-between" data-sort="endDate" data-direction="asc">
                <span>End Date (Soonest)</span>
                <span class="sort-indicator hidden">✓</span>
            </button>
            
            <button class="sort-option w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-between" data-sort="endDate" data-direction="desc">
                <span>End Date (Latest)</span>
                <span class="sort-indicator hidden">✓</span>
            </button>
            
            <button class="sort-option w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-between" data-sort="status" data-direction="asc">
                <span>Status (A-Z)</span>
                <span class="sort-indicator hidden">✓</span>
            </button>
            
            <div class="border-t border-gray-200 dark:border-gray-700 my-1"></div>
            
            <button id="clearSort" class="w-full text-left px-4 py-2 text-sm text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800">
                Clear Sort
            </button>
        </div>
    </div>
</div>
                        <button id="addFileBtn" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-primary rounded-lg hover:bg-primary/90">
                            <span class="material-symbols-outlined text-base">add</span>
                            Add File
                        </button>
                    </div>
                </div>

                <!-- Bulk Operations Toolbar -->
                <div id="bulkOperationsToolbar" class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4 hidden">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <span class="text-sm font-medium text-blue-700 dark:text-blue-300">
                                <span id="selectedCount">0</span> item(s) selected
                            </span>
                            <div class="flex items-center gap-2">
                                <button id="selectAllBtn" class="text-xs px-3 py-1 bg-blue-100 dark:bg-blue-800 text-blue-700 dark:text-blue-300 rounded hover:bg-blue-200 dark:hover:bg-blue-700">
                                    Select All
                                </button>
                                <button id="selectNoneBtn" class="text-xs px-3 py-1 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-200 dark:hover:bg-gray-700">
                                    &nbsp;
                                </button>
                            </div>
                        </div>
                        <button id="bulkDeleteBtn" class="disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <img src="assets/images/delete.png" alt="Delete" class="w-6 h-6">
                        </button>
                    </div>
                </div>

                <div class="bg-card-light dark:bg-card-dark rounded-xl shadow-soft overflow-hidden border border-border-light dark:border-border-dark">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-border-light dark:divide-border-dark">
                            <thead class="bg-gray-50 dark:bg-white/5">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-text-muted-light dark:text-text-muted-dark uppercase tracking-wider">
                                        <input type="checkbox" id="selectAllCheckbox" class="w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary dark:focus:ring-primary dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text-muted-light dark:text-text-muted-dark uppercase tracking-wider">Institution</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text-muted-light dark:text-text-muted-dark uppercase tracking-wider">Location</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text-muted-light dark:text-text-muted-dark uppercase tracking-wider">Contact Details</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text-muted-light dark:text-text-muted-dark uppercase tracking-wider">Term</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text-muted-light dark:text-text-muted-dark uppercase tracking-wider">Sign Date</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text-muted-light dark:text-text-muted-dark uppercase tracking-wider">End Date</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text-muted-light dark:text-text-muted-dark uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text-muted-light dark:text-text-muted-dark uppercase tracking-wider">File Link</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-text-muted-light dark:text-text-muted-dark uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-border-light dark:divide-border-dark">
                                <!-- Table rows will be populated from localStorage data -->
                            </tbody>
                        </table>
                    </div>
                    <div class="px-4 py-3 flex items-center justify-between border-t border-border-light dark:border-border-dark sm:px-6">
                        <div class="flex-1 flex justify-between sm:hidden">
                            <button id="prevBtnMobile" class="relative inline-flex items-center px-4 py-2 border border-border-light text-sm font-medium rounded-md text-text-light bg-card-light hover:bg-gray-50 dark:text-text-muted-dark dark:border-border-dark dark:bg-background-dark/50 dark:hover:bg-card-dark disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                            <button id="nextBtnMobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-border-light text-sm font-medium rounded-md text-text-light bg-card-light hover:bg-gray-50 dark:text-text-muted-dark dark:border-border-dark dark:bg-background-dark/50 dark:hover:bg-card-dark disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                        </div>
                        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                            <div>
                                <p class="text-sm text-text-muted-light dark:text-text-muted-dark">Showing <span class="font-medium" id="startEntry">1</span> to <span class="font-medium" id="endEntry">6</span> of <span class="font-medium" id="totalEntries">0</span> results</p>
                            </div>
                            <div>
                                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination" id="paginationNav">
                                    <!-- Pagination buttons will be generated dynamically -->
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
</div>
<!-- Modal Overlay and Container -->
<div id="addFileModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
    <div class="w-full max-w-lg bg-white dark:bg-background-dark rounded-xl shadow-2xl m-4 flex flex-col max-h-[90vh]">
        <!-- Modal Header -->
        <div class="p-6 border-b border-gray-200 dark:border-gray-800 flex-shrink-0">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">Add MOU/MOA File</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Fill in the details below to add a new memorandum.</p>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6 space-y-4 overflow-y-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="institution">Institution</label>
                    <input class="w-full bg-gray-50 dark:bg-background-dark/50 border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="institution" placeholder="e.g., Central Philippine University" type="text"/>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="location">Location</label>
                    <input class="w-full bg-gray-50 dark:bg-background-dark/50 border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="location" placeholder="e.g., Iloilo City" type="text"/>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="contact">Contact Details <span class="text-gray-500 dark:text-gray-400 text-xs">(Optional)</span></label>
                <input class="w-full bg-gray-50 dark:bg-background-dark/50 border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="contact" placeholder="e.g., email@example.com" type="text"/>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="sign-date">Sign Date</label>
                    <input class="w-full bg-gray-50 dark:bg-background-dark/50 border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="sign-date" type="date"/>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="end-date">End Date</label>
                    <input class="w-full bg-gray-50 dark:bg-background-dark/50 border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="end-date" type="date"/>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="term">Term</label>
                    <input class="w-full bg-gray-50 dark:bg-background-dark/50 border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary" id="term" placeholder="e.g., 3 Years" type="text"/>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" for="auto-status">Status</label>
                    <div class="w-full bg-gray-100 dark:bg-background-dark/30 border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-500 dark:text-gray-400">
                        <span id="autoStatusText">Will be determined automatically</span>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Status is automatically set based on the end date</p>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Upload Document</label>
                <div class="mt-2 flex justify-center rounded-lg border border-dashed border-gray-300 dark:border-gray-700 px-6 py-6">
                    <div class="text-center">
                        <span class="material-symbols-outlined text-4xl text-gray-400 dark:text-gray-600">cloud_upload</span>
                        <div class="mt-2 flex text-sm leading-6 text-gray-600 dark:text-gray-400">
                            <label class="relative cursor-pointer rounded-md font-semibold text-primary focus-within:outline-none focus-within:ring-2 focus-within:ring-primary focus-within:ring-offset-2 dark:focus-within:ring-offset-background-dark hover:text-primary/80" for="file-upload">
                                <span>Upload a file</span>
                                <input class="sr-only" id="file-upload" name="file-upload" type="file" accept=".pdf,.docx"/>
                            </label>
                            <p class="pl-1">or drag and drop</p>
                        </div>
                        <p class="text-xs leading-5 text-gray-600 dark:text-gray-500">PDF, DOCX up to 10MB</p>
                    </div>
                </div>
                <!-- Selected file display -->
                <div id="selected-file-display" class="mt-3 hidden">
                    <div class="flex items-center justify-between bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg px-3 py-2">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-green-600 dark:text-green-400 text-sm">check_circle</span>
                            <span class="text-sm text-green-700 dark:text-green-300" id="selected-file-name"></span>
                        </div>
                        <button type="button" id="remove-file" class="text-green-600 dark:text-green-400 hover:text-green-800 dark:hover:text-green-200">
                            <span class="material-symbols-outlined text-sm">close</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="p-4 bg-gray-50 dark:bg-background-dark/30 rounded-b-xl flex justify-end gap-3 flex-shrink-0">
            <button id="cancelBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-background-dark/50 dark:text-gray-300 dark:border-gray-700 dark:hover:bg-gray-800">Cancel</button>
            <button id="saveBtn" class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-lg hover:bg-primary/90">Save</button>
        </div>
    </div>
</div>
<!-- File Viewer Modal -->
<div id="fileViewerModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
    <div class="w-full max-w-4xl bg-white dark:bg-background-dark rounded-xl shadow-2xl m-4 flex flex-col max-h-[90vh]">
        <!-- Modal Header -->
        <div class="p-6 border-b border-gray-200 dark:border-gray-800 flex-shrink-0 flex items-center justify-between">
            <div>
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white" id="fileViewerTitle">View File</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1" id="fileViewerSubtitle">Document preview</p>
            </div>
            <button id="closeFileViewer" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500 dark:text-gray-400">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6 flex-1 overflow-hidden">
            <div class="w-full h-full flex items-center justify-center bg-gray-50 dark:bg-gray-900 rounded-lg">
                <div id="fileViewerContent" class="w-full h-full flex items-center justify-center">
                    <!-- File content will be displayed here -->
                    <div class="text-center">
                        <span class="material-symbols-outlined text-6xl text-gray-400 dark:text-gray-600 mb-4">description</span>
                        <p class="text-gray-500 dark:text-gray-400">File preview will be displayed here</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="p-4 bg-gray-50 dark:bg-background-dark/30 rounded-b-xl flex justify-between items-center flex-shrink-0">
            <div class="flex items-center gap-2">
                <button id="downloadFile" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-primary bg-primary/10 rounded-lg hover:bg-primary/20">
                    <span class="material-symbols-outlined text-sm">download</span>
                    Download
                </button>
            </div>
            <button id="closeFileViewerBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-background-dark/50 dark:text-gray-300 dark:border-gray-700 dark:hover:bg-gray-800">Close</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
    <div class="w-full max-w-md bg-white dark:bg-background-dark rounded-xl shadow-2xl m-4">
        <!-- Modal Header -->
        <div class="p-6 border-b border-gray-200 dark:border-gray-800">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-red-100 dark:bg-red-900/20 rounded-full flex items-center justify-center">
                    <span class="material-symbols-outlined text-red-600 dark:text-red-400 text-xl">warning</span>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Delete MOU/MOA</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">This action cannot be undone</p>
                </div>
            </div>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6">
            <p class="text-gray-700 dark:text-gray-300">
                Are you sure you want to delete this MOU/MOA? This will permanently remove the entry and all associated data.
            </p>
        </div>
        
        <!-- Modal Footer -->
        <div class="p-6 bg-gray-50 dark:bg-background-dark/30 rounded-b-xl flex justify-end gap-3">
            <button id="cancelDelete" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-background-dark/50 dark:text-gray-300 dark:border-gray-700 dark:hover:bg-gray-800">
                Cancel
            </button>
            <button id="confirmDelete" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                Delete
            </button>
        </div>
    </div>
</div>

<!-- Bulk Delete Confirmation Modal -->
<div id="bulkDeleteConfirmModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
    <div class="w-full max-w-md bg-white dark:bg-background-dark rounded-xl shadow-2xl m-4">
        <!-- Modal Header -->
        <div class="p-6 border-b border-gray-200 dark:border-gray-800">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-red-100 dark:bg-red-900/20 rounded-full flex items-center justify-center">
                    <span class="material-symbols-outlined text-red-600 dark:text-red-400 text-xl">warning</span>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Delete Selected Items</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">This action cannot be undone</p>
                </div>
            </div>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6">
            <p class="text-gray-700 dark:text-gray-300">
                Are you sure you want to delete <span id="bulkDeleteCount" class="font-semibold">0</span> selected MOU/MOA entries? This will permanently remove all selected entries and their associated data.
            </p>
        </div>
        
        <!-- Modal Footer -->
        <div class="p-6 bg-gray-50 dark:bg-background-dark/30 rounded-b-xl flex justify-end gap-3">
            <button id="cancelBulkDelete" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-background-dark/50 dark:text-gray-300 dark:border-gray-700 dark:hover:bg-gray-800">
                Cancel
            </button>
            <button id="confirmBulkDelete" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                Delete
            </button>
        </div>
    </div>
</div>

<!-- Bulk Operations JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Bulk operations elements with null checks
        const bulkToolbar = document.getElementById('bulkOperationsToolbar');
        const selectedCount = document.getElementById('selectedCount');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const selectNoneBtn = document.getElementById('selectNoneBtn');
        const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const bulkDeleteModal = document.getElementById('bulkDeleteConfirmModal');
        const bulkDeleteCount = document.getElementById('bulkDeleteCount');
        const cancelBulkDeleteBtn = document.getElementById('cancelBulkDelete');
        const confirmBulkDeleteBtn = document.getElementById('confirmBulkDelete');

        // Only proceed if bulk operations elements exist
        if (!bulkToolbar || !selectedCount || !selectAllBtn || !selectNoneBtn || !bulkDeleteBtn || !selectAllCheckbox) {
            console.log('Bulk operations elements not found. Bulk functionality disabled.');
            return;
        }

        // Track selected items
        let selectedItems = new Set();

        // Function to update bulk operations UI
        function updateBulkOperationsUI() {
            // Count actual checked checkboxes instead of using selectedItems Set
            const checkedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            const count = checkedCheckboxes.length;
            
            if (selectedCount) selectedCount.textContent = count;
            
            if (count > 0) {
                if (bulkToolbar) bulkToolbar.classList.remove('hidden');
                if (bulkDeleteBtn) bulkDeleteBtn.disabled = false;
            } else {
                if (bulkToolbar) bulkToolbar.classList.add('hidden');
                if (bulkDeleteBtn) bulkDeleteBtn.disabled = true;
            }

            // Update select all checkbox state
            const allCheckboxes = document.querySelectorAll('.row-checkbox');
            
            if (selectAllCheckbox) {
                if (checkedCheckboxes.length === 0) {
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.checked = false;
                } else if (checkedCheckboxes.length === allCheckboxes.length) {
                    selectAllCheckbox.indeterminate = false;
                    selectAllCheckbox.checked = true;
                } else {
                    selectAllCheckbox.indeterminate = true;
                    selectAllCheckbox.checked = false;
                }
            }
        }

        // Function to handle individual checkbox change
        function handleRowCheckboxChange(checkbox) {
            // No need to maintain selectedItems Set anymore
            updateBulkOperationsUI();
        }

        // Add event listener to new checkboxes
        function addCheckboxEventListener(checkbox) {
            checkbox.addEventListener('change', function() {
                handleRowCheckboxChange(this);
            });
        }

        // Select all functionality
        selectAllBtn.addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            updateBulkOperationsUI();
        });

        // Select all checkbox functionality
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkOperationsUI();
        });

        // Select none functionality
        selectNoneBtn.addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateBulkOperationsUI();
        });

        // Bulk delete functionality
        bulkDeleteBtn.addEventListener('click', function() {
            const checkedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            if (checkedCheckboxes.length > 0) {
                bulkDeleteCount.textContent = checkedCheckboxes.length;
                bulkDeleteModal.classList.remove('hidden');
            }
        });

        // Cancel bulk delete
        cancelBulkDeleteBtn.addEventListener('click', function() {
            bulkDeleteModal.classList.add('hidden');
        });

        // Confirm bulk delete
        confirmBulkDeleteBtn.addEventListener('click', function() {
            // Get IDs from actually checked checkboxes
            const checkedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            const idsToDelete = Array.from(checkedCheckboxes).map(checkbox => parseInt(checkbox.dataset.id));
            
            try {
                // Get current entries directly
                const STORAGE_KEY = 'mou_moa_entries';
                const entries = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                
                // Filter out selected entries
                const filteredEntries = entries.filter(entry => !idsToDelete.includes(entry.id));
                
                // Save updated entries
                localStorage.setItem(STORAGE_KEY, JSON.stringify(filteredEntries));
                
                // Remove rows from table
                idsToDelete.forEach(id => {
                    const checkbox = document.querySelector(`.row-checkbox[data-id="${id}"]`);
                    if (checkbox) {
                        const row = checkbox.closest('tr');
                        if (row) {
                            row.remove();
                        }
                    }
                });
                
                // Close modal
                bulkDeleteModal.classList.add('hidden');
                
                // Update pagination display (self-contained)
                const totalEntries = filteredEntries.length;
                const startEntry = totalEntries > 0 ? 1 : 0;
                const endEntry = totalEntries;
                
                const paginationContainer = document.querySelector('.hidden.sm\\:flex-1.sm\\:flex.sm\\:items-center.sm\\:justify-between');
                if (paginationContainer) {
                    const paginationText = paginationContainer.querySelector('div p');
                    if (paginationText) {
                        paginationText.innerHTML = `Showing <span class="font-medium">${startEntry}</span> to <span class="font-medium">${endEntry}</span> of <span class="font-medium">${totalEntries}</span> results`;
                    }
                }
                
            } catch (error) {
                console.error('Error during bulk delete:', error);
                
                // Show error message (self-contained)
                const errorToast = document.createElement('div');
                errorToast.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                errorToast.textContent = 'Failed to delete selected entries: ' + error.message;
                document.body.appendChild(errorToast);
                
                setTimeout(() => {
                    if (document.body.contains(errorToast)) {
                        document.body.removeChild(errorToast);
                    }
                }, 5000);
            }
        });

        // Close modal when clicking outside
        bulkDeleteModal.addEventListener('click', function(e) {
            if (e.target === bulkDeleteModal) {
                bulkDeleteModal.classList.add('hidden');
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && bulkDeleteModal && !bulkDeleteModal.classList.contains('hidden')) {
                bulkDeleteModal.classList.add('hidden');
            }
        });

        // Initialize checkboxes for existing rows
        document.querySelectorAll('.row-checkbox').forEach(checkbox => {
            addCheckboxEventListener(checkbox);
        });

        // Make addCheckboxEventListener globally accessible for new rows
        window.addCheckboxEventListener = addCheckboxEventListener;

        // Initialize UI
        updateBulkOperationsUI();
    });
</script>

<!-- Updated addRowToTable function to include checkboxes -->
<script>
    // Override the existing addRowToTable function to include checkboxes
    window.addRowToTableWithCheckbox = function(data) {
        const tableBody = document.querySelector('tbody');
        const newRow = document.createElement('tr');
        
        // Determine status badge class
        let statusBadgeClass = '';
        if (data.status === 'Active') {
            statusBadgeClass = 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300';
        } else if (data.status === 'Expired') {
            statusBadgeClass = 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300';
        } else if (data.status === 'Expires Soon') {
            statusBadgeClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300';
        } else {
            statusBadgeClass = 'bg-gray-100 text-gray-800 dark:bg-gray-900/50 dark:text-gray-300';
        }
        
        newRow.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-center">
                <input type="checkbox" class="row-checkbox w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary dark:focus:ring-primary dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" data-id="${data.id}">
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-text-light dark:text-text-dark text-left">${data.institution}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted-light dark:text-text-muted-dark text-center">${data.location}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted-light dark:text-text-muted-dark text-left">${data.contact_email}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted-light dark:text-text-muted-dark text-center">${data.term}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted-light dark:text-text-muted-dark text-center">${data.sign_date}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted-light dark:text-text-muted-dark text-center">${data.end_date}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusBadgeClass}">${data.status}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                ${data.file_name ? 
                    `<button class="view-file-btn text-primary hover:text-primary/80 dark:text-primary-400 dark:hover:text-primary-300 flex items-center gap-1 mx-auto" data-file-path="${data.file_path}" data-file-name="${data.file_name}" title="View File">
                        <span class="material-symbols-outlined text-sm">visibility</span>
                        <span>View</span>
                    </button>` : 
                    `<span class="text-gray-400 dark:text-gray-500 text-sm">No file</span>`
                }
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                <div class="flex items-center justify-center gap-2">
                    <button class="edit-btn text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-200" data-id="${data.id}" title="Edit MOU/MOA">
                        <img src="assets/images/edit.png" alt="Edit" class="w-4 h-4">
                    </button>
                    <button class="delete-btn text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-200" data-id="${data.id}" title="Delete MOU/MOA">
                        <img src="assets/images/trash.png" alt="Delete" class="w-4 h-4">
                    </button>
                </div>
            </td>
        `;
        
        tableBody.appendChild(newRow);
        
        // Add checkbox event listener
        const checkbox = newRow.querySelector('.row-checkbox');
        if (checkbox && window.addCheckboxEventListener) {
            window.addCheckboxEventListener(checkbox);
        }
        
        // Add other event listeners (existing functionality)
        const deleteBtn = newRow.querySelector('.delete-btn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function() {
                deleteEntry(data.id);
            });
        }

        const viewFileBtn = newRow.querySelector('.view-file-btn');
        if (viewFileBtn) {
            viewFileBtn.addEventListener('click', function() {
                const filePath = this.dataset.filePath;
                const fileName = this.dataset.fileName;
                showFileViewer(filePath, fileName);
            });
        }

        const editBtn = newRow.querySelector('.edit-btn');
        if (editBtn) {
            editBtn.addEventListener('click', function() {
                editEntry(data.id);
            });
        }

        // Add click listener for row details (add this to the existing addRowToTable function)
        addRowClickListener(newRow, data);
    };

    // Replace the original addRowToTable function calls
    if (typeof addRowToTable !== 'undefined') {
        window.originalAddRowToTable = addRowToTable;
        window.addRowToTable = window.addRowToTableWithCheckbox;
    }
</script>

</main>
</div>
<script>
        document.addEventListener('DOMContentLoaded', () => {
            const themeToggle = document.getElementById('theme-toggle');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const appContainer = document.getElementById('app-container');
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('main');
            const sidebarLogoText = document.querySelector('.sidebar-logo-text');
            const sidebarTexts = document.querySelectorAll('.sidebar-text');
            const sidebarProfileInfo = document.querySelector('.sidebar-profile-info');
            const sidebarProfilePicture = document.querySelector('.sidebar-profile-picture');
            const openIcon = document.querySelector('.sidebar-toggle-icon-open');
            const closedIcon = document.querySelector('.sidebar-toggle-icon-closed');
            const navLinks = document.querySelectorAll('.sidebar-nav-link');
            const profileContainer = document.querySelector('.profile-container');
            const toggleContainer = document.querySelector('.sidebar-toggle-container');
            // Prevent navigating when clicking the current page link
            const currentPath = window.location.pathname.split('/').pop();
            navLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (href === currentPath) {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                    });
                }
            });
            // Function to toggle sidebar
            const toggleSidebar = () => {
                const isCollapsed = appContainer.classList.contains('sidebar-collapsed');
                if (isCollapsed) {
                    appContainer.classList.remove('sidebar-collapsed');
                    sidebar.style.width = '16rem';
                    mainContent.style.marginLeft = '0';
                    sidebarLogoText.classList.remove('hidden');
                    sidebarTexts.forEach(text => text.classList.remove('hidden'));
                    sidebarProfileInfo.classList.remove('hidden');
                    sidebarProfilePicture.classList.remove('hidden');
                    openIcon.style.display = 'block';
                    closedIcon.style.display = 'none';
                    navLinks.forEach(link => link.classList.remove('justify-center'));
                    profileContainer.classList.remove('justify-center');
                    toggleContainer.classList.remove('justify-center');
                } else {
                    appContainer.classList.add('sidebar-collapsed');
                    sidebar.style.width = '5rem';
                    mainContent.style.marginLeft = '5rem';
                    sidebarLogoText.classList.add('hidden');
                    sidebarTexts.forEach(text => text.classList.add('hidden'));
                    sidebarProfileInfo.classList.add('hidden');
                    sidebarProfilePicture.classList.add('hidden');
                    openIcon.style.display = 'none';
                    closedIcon.style.display = 'block';
                    navLinks.forEach(link => link.classList.add('justify-center'));
                    profileContainer.classList.add('justify-center');
                    toggleContainer.classList.add('justify-center');
                }
                // Add a small delay for the chart to re-render after transition
                setTimeout(() => {
                    if (window.awardsProgressChartInstance) {
                        window.awardsProgressChartInstance.resize();
                    }
                }, 350);
            };
            sidebarToggle.addEventListener('click', toggleSidebar);
            // Function to toggle dark mode
            const toggleDarkMode = (enable) => {
                if (enable) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
                // Force a re-render to ensure all elements update
                document.body.offsetHeight;
            };
            // Check for saved theme in localStorage
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                toggleDarkMode(true);
            } else {
                toggleDarkMode(false);
            }
            // Event listener for theme toggle button
            themeToggle.addEventListener('click', () => {
                const isCurrentlyDark = document.documentElement.classList.contains('dark');
                toggleDarkMode(!isCurrentlyDark);
                // Re-render chart on theme change
                if (window.awardsProgressChartInstance) {
                    window.awardsProgressChartInstance.destroy();
                }
                renderChart();
            });
            // Chart.js rendering
            const renderChart = () => {
                const canvas = document.getElementById('awardsProgressChart');
                if (!canvas) {
                    console.log('Chart canvas not found, skipping chart rendering');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                const isDarkMode = document.documentElement.classList.contains('dark');
                const gridColor = isDarkMode ? tailwind.theme.extend.colors.border-dark : tailwind.theme.extend.colors.border-light;
                const tickColor = isDarkMode ? tailwind.theme.extend.colors['text-muted-dark'] : tailwind.theme.extend.colors['text-muted-light'];
                const legendColor = isDarkMode ? tailwind.theme.extend.colors['text-dark'] : tailwind.theme.extend.colors['text-light'];
                const data = {
                    labels: ['Teaching', 'Research', 'Extension', 'Support', 'Admin'],
                    datasets: [{
                        label: 'Award Progress',
                        data: [75, 60, 90, 45, 82],
                        backgroundColor: [
                            'rgba(19, 127, 236, 0.2)', // primary
                            'rgba(34, 197, 94, 0.2)', // green
                            'rgba(234, 179, 8, 0.2)', // yellow
                            'rgba(239, 68, 68, 0.2)', // red
                            'rgba(99, 102, 241, 0.2)', // indigo
                        ],
                        borderColor: [
                            'rgb(19, 127, 236)', // primary
                            'rgb(34, 197, 94)', // green
                            'rgb(234, 179, 8)', // yellow
                            'rgb(239, 68, 68)', // red
                            'rgb(99, 102, 241)', // indigo
                        ],
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                };
                const options = {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: gridColor,
                                drawBorder: false,
                            },
                            ticks: {
                                color: tickColor,
                                padding: 10,
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false,
                            },
                            ticks: {
                                color: tickColor,
                                padding: 10,
                            }
                        }
                    }
                };
                window.awardsProgressChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: data,
                    options: options
                });
            };
            renderChart();
        });
    </script>

    <!-- Modal functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const addFileBtn = document.getElementById('addFileBtn');
            const modal = document.getElementById('addFileModal');
            const cancelBtn = document.getElementById('cancelBtn');
            const saveBtn = document.getElementById('saveBtn');
            const fileUploadInput = document.getElementById('file-upload');
            const selectedFileDisplay = document.getElementById('selected-file-display');
            const selectedFileNameDisplay = document.getElementById('selected-file-name');
            const removeFileBtn = document.getElementById('remove-file');

            // Pagination variables
            let currentPage = 1;
            const itemsPerPage = 6;
            let allEntries = [];

            // Show modal when Add File button is clicked
            if (addFileBtn && modal) {
                addFileBtn.addEventListener('click', function() {
                    // Reset editing state
                    window.editingEntryId = undefined;
                    
                    // Reset modal title and button text for adding
                    const modalTitle = document.querySelector('#addFileModal h3');
                    const saveBtn = document.getElementById('saveBtn');
                    modalTitle.textContent = 'Add MOU/MOA File';
                    saveBtn.textContent = 'Save';
                    
                    modal.classList.remove('hidden');
                    // Clear selected file display when opening modal
                    updateSelectedFileDisplay(null);
                });
            }

            // Hide modal when Cancel button is clicked
            if (cancelBtn && modal) {
                cancelBtn.addEventListener('click', function() {
                    modal.classList.add('hidden');
                    // Clear selected file display when closing modal
                    updateSelectedFileDisplay(null);
                });
            }

            // Hide modal when clicking outside of it
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                        // Clear selected file display when closing modal
                        updateSelectedFileDisplay(null);
                    }
                });
            }

            // Function to update selected file display
            function updateSelectedFileDisplay(file) {
                if (file) {
                    selectedFileNameDisplay.textContent = file.name;
                    selectedFileDisplay.classList.remove('hidden');
                } else {
                    selectedFileNameDisplay.textContent = '';
                    selectedFileDisplay.classList.add('hidden');
                }
            }

            // Event listener for file input change
            if (fileUploadInput) {
                fileUploadInput.addEventListener('change', function(event) {
                    const file = this.files[0];
                    if (file) {
                        // Validate file type
                        const allowedTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
                        if (!allowedTypes.includes(file.type)) {
                            alert('Please select a PDF or DOCX file.');
                            this.value = '';
                            return;
                        }
                        
                        // Validate file size (10MB = 10 * 1024 * 1024 bytes)
                        if (file.size > 10 * 1024 * 1024) {
                            alert('File size must be less than 10MB.');
                            this.value = '';
                            return;
                        }
                        
                        updateSelectedFileDisplay(file);
                    }
                });
            }

            // Event listener for remove file button
            if (removeFileBtn) {
                removeFileBtn.addEventListener('click', function() {
                    fileUploadInput.value = ''; // Clear the file input
                    updateSelectedFileDisplay(null); // Hide the display
                });
            }

            // Enhanced status determination with "Expires Soon"
            function determineStatus(endDate) {
                if (!endDate) {
                    return 'Will be determined automatically';
                }
                
                const today = new Date();
                const endDateObj = new Date(endDate);
                
                // Set time to start of day for accurate comparison
                today.setHours(0, 0, 0, 0);
                endDateObj.setHours(0, 0, 0, 0);
                
                // Calculate days until expiry
                const daysUntilExpiry = Math.ceil((endDateObj - today) / (1000 * 60 * 60 * 24));
                
                if (endDateObj < today) {
                    return 'Expired';
                } else if (daysUntilExpiry <= 30) {
                    return 'Expires Soon';
                } else {
                    return 'Active';
                }
            }
            
            // Function to get status value for saving
            function getStatusValue(endDate) {
                if (!endDate) {
                    return 'Pending'; // Default if no end date provided
                }
                
                const today = new Date();
                const endDateObj = new Date(endDate);
                
                // Set time to start of day for accurate comparison
                today.setHours(0, 0, 0, 0);
                endDateObj.setHours(0, 0, 0, 0);
                
                // Calculate days until expiry
                const daysUntilExpiry = Math.ceil((endDateObj - today) / (1000 * 60 * 60 * 24));
                
                if (endDateObj < today) {
                    return 'Expired';
                } else if (daysUntilExpiry <= 30) {
                    return 'Expires Soon';
                } else {
                    return 'Active';
                }
            }
            
            // Update status when end date changes
            const endDateInput = document.getElementById('end-date');
            const autoStatusText = document.getElementById('autoStatusText');
            
            endDateInput.addEventListener('change', function() {
                const status = determineStatus(this.value);
                autoStatusText.textContent = status;
                
                // Update text color based on status
                if (status === 'Active') {
                    autoStatusText.className = 'text-green-600 dark:text-green-400';
                } else if (status === 'Expired') {
                    autoStatusText.className = 'text-red-600 dark:text-red-400';
                } else if (status === 'Expires Soon') {
                    autoStatusText.className = 'text-yellow-600 dark:text-yellow-400';
                } else {
                    autoStatusText.className = 'text-gray-500 dark:text-gray-400';
                }
            });
            
            // Function to calculate end date based on sign date and term
            function calculateEndDate(signDate, term) {
                if (!signDate || !term) return null;
                
                let number, unit;
                
                // First try to parse with explicit unit (e.g., "5 years", "3 months")
                const termMatch = term.match(/(\d+)\s*(year|years|month|months|day|days)/i);
                
                if (termMatch) {
                    number = parseInt(termMatch[1]);
                    unit = termMatch[2].toLowerCase();
                } else {
                    // If no unit specified, try to parse just a number (assume years)
                    const numberMatch = term.match(/(\d+)/);
                    if (numberMatch) {
                        number = parseInt(numberMatch[1]);
                        unit = 'years'; // Default to years if no unit specified
                    } else {
                        return null;
                    }
                }
                
                const startDate = new Date(signDate);
                if (isNaN(startDate.getTime())) return null;
                
                const endDate = new Date(startDate);
                
                switch (unit) {
                    case 'year':
                    case 'years':
                        endDate.setFullYear(startDate.getFullYear() + number);
                        break;
                    case 'month':
                    case 'months':
                        endDate.setMonth(startDate.getMonth() + number);
                        break;
                    case 'day':
                    case 'days':
                        endDate.setDate(startDate.getDate() + number);
                        break;
                    default:
                        return null;
                }
                
                // Format as YYYY-MM-DD
                return endDate.toISOString().split('T')[0];
            }
            
            // Function to auto-calculate end date when sign date or term changes
            function autoCalculateEndDate() {
                const signDate = document.getElementById('sign-date').value;
                const term = document.getElementById('term').value.trim();
                const endDateInput = document.getElementById('end-date');
                
                if (signDate && term) {
                    const calculatedEndDate = calculateEndDate(signDate, term);
                    if (calculatedEndDate) {
                        endDateInput.value = calculatedEndDate;
                        
                        // Update status display
                        const status = determineStatus(calculatedEndDate);
                        autoStatusText.textContent = status;
                        
                        // Update text color based on status
                        if (status === 'Active') {
                            autoStatusText.className = 'text-green-600 dark:text-green-400';
                        } else if (status === 'Expired') {
                            autoStatusText.className = 'text-red-600 dark:text-red-400';
                        } else if (status === 'Expires Soon') {
                            autoStatusText.className = 'text-yellow-600 dark:text-yellow-400';
                        } else {
                            autoStatusText.className = 'text-gray-500 dark:text-gray-400';
                        }
                        
                        // Notification removed - no message will be shown when end date is calculated
                    }
                }
            }
            
            // Function to show temporary messages
            function showTemporaryMessage(message, type = 'info') {
                const messageDiv = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-blue-500';
                messageDiv.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm`;
                messageDiv.textContent = message;
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    if (document.body.contains(messageDiv)) {
                        document.body.removeChild(messageDiv);
                    }
                }, 2000);
            }
            
            // Add event listeners for auto-calculation
            const signDateInput = document.getElementById('sign-date');
            const termInput = document.getElementById('term');
            
            signDateInput.addEventListener('change', autoCalculateEndDate);
            signDateInput.addEventListener('input', autoCalculateEndDate);
            
            termInput.addEventListener('change', autoCalculateEndDate);
            termInput.addEventListener('input', autoCalculateEndDate);
            
            // Handle Save button
            if (saveBtn) {
                saveBtn.addEventListener('click', async function() {
                    // Get form data
                    const institution = document.getElementById('institution').value.trim();
                    const location = document.getElementById('location').value.trim();
                    const contact = document.getElementById('contact').value.trim();
                    const term = document.getElementById('term').value.trim();
                    const signDate = document.getElementById('sign-date').value;
                    const endDate = document.getElementById('end-date').value;
                    const fileUpload = document.getElementById('file-upload').files[0];
                    
                    // Validate required fields (contact details is now optional)
                    if (!institution || !location || !term || !signDate || !endDate) {
                        alert('Please fill in all required fields (Institution, Location, Term, Sign Date, and End Date).');
                        return;
                    }
                    
                    // Create new MOU/MOA entry
                    let calculatedStatus;
                    try {
                        // Calculate status directly here instead of calling getStatusValue
                        if (!endDate) {
                            calculatedStatus = 'Pending';
                        } else {
                            const today = new Date();
                            const endDateObj = new Date(endDate);
                            
                            // Set time to start of day for accurate comparison
                            today.setHours(0, 0, 0, 0);
                            endDateObj.setHours(0, 0, 0, 0);
                            
                            // Calculate days until expiry
                            const daysUntilExpiry = Math.ceil((endDateObj - today) / (1000 * 60 * 60 * 24));
                            
                            if (endDateObj < today) {
                                calculatedStatus = 'Expired';
                            } else if (daysUntilExpiry <= 30) {
                                calculatedStatus = 'Expires Soon';
                            } else {
                                calculatedStatus = 'Active';
                            }
                        }
                        console.log('Status calculated:', calculatedStatus);
                    } catch (error) {
                        console.error('Error calculating status:', error);
                        calculatedStatus = 'Active'; // Fallback
                    }
                    
                    const newEntry = {
                        institution: institution,
                        location: location,
                        contact_email: contact,
                        term: term,
                        sign_date: signDate,
                        end_date: endDate,
                        status: calculatedStatus || 'Active', // Ensure status is never undefined
                        file_name: fileUpload ? fileUpload.name : null,
                        file_path: fileUpload ? `/uploads/${fileUpload.name}` : null
                    };
                    
                    console.log('New Entry:', newEntry);
                    
                    try {
                        // Show loading state
                        saveBtn.disabled = true;
                        saveBtn.textContent = 'Saving...';
                        
                        // Save to database
                        const result = await saveToDatabase(newEntry);
                        
                        // Add to table display with the ID from database
                        addRowToTable({...newEntry, id: result.id});
                        
                        // Reset form
                        resetForm();
                        
                        // Close modal
                        const modal = document.getElementById('addFileModal');
                        modal.classList.add('hidden');
                        
                        // Success message removed - no notification will be shown
                        
                    } catch (error) {
                        showErrorMessage('Failed to save data: ' + error.message);
                    } finally {
                        // Reset button state
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Save';
                    }
                });
            }
            
            // Function to add new row to table
            function addRowToTable(data) {
                const tableBody = document.querySelector('tbody');
                const newRow = document.createElement('tr');
                
                // Determine status badge class
                let statusBadgeClass = '';
                if (data.status === 'Active') {
                    statusBadgeClass = 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300';
                } else if (data.status === 'Expired') {
                    statusBadgeClass = 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300';
                } else if (data.status === 'Expires Soon') {
                    statusBadgeClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300';
                } else {
                    statusBadgeClass = 'bg-gray-100 text-gray-800 dark:bg-gray-900/50 dark:text-gray-300';
                }
                
                newRow.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <input type="checkbox" class="row-checkbox w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary dark:focus:ring-primary dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" data-id="${data.id}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-text-light dark:text-text-dark text-left">${data.institution}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted-light dark:text-text-muted-dark text-center">${data.location}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted-light dark:text-text-muted-dark text-left">${data.contact_email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted-light dark:text-text-muted-dark text-center">${data.term}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted-light dark:text-text-muted-dark text-center">${data.sign_date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted-light dark:text-text-muted-dark text-center">${data.end_date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusBadgeClass}">${data.status}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                        ${data.file_name ? 
                            `<button class="view-file-btn text-primary hover:text-primary/80 dark:text-primary-400 dark:hover:text-primary-300 flex items-center gap-1 mx-auto" data-file-path="${data.file_path}" data-file-name="${data.file_name}" title="View File">
                                <span class="material-symbols-outlined text-sm">visibility</span>
                                <span>View</span>
                            </button>` : 
                            `<span class="text-gray-400 dark:text-gray-500 text-sm">No file</span>`
                        }
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                        <div class="flex items-center justify-center gap-2">
                            <button class="edit-btn text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-200" data-id="${data.id}" title="Edit MOU/MOA">
                                <img src="assets/images/edit.png" alt="Edit" class="w-4 h-4">
                            </button>
                            <button class="delete-btn text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-200" data-id="${data.id}" title="Delete MOU/MOA">
                                <img src="assets/images/trash.png" alt="Delete" class="w-4 h-4">
                            </button>
                        </div>
                    </td>
                `;
                
                // Add to beginning of table (most recent first)
                tableBody.insertBefore(newRow, tableBody.firstChild);
                
                // Update pagination display
                updatePaginationDisplay();
                
                // Add delete event listener to the new button
                const deleteBtn = newRow.querySelector('.delete-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function() {
                        deleteEntry(data.id);
                    });
                }

                // Add view file event listener to the new button (only if it exists)
                const viewFileBtn = newRow.querySelector('.view-file-btn');
                if (viewFileBtn) {
                    viewFileBtn.addEventListener('click', function() {
                        const filePath = this.dataset.filePath;
                        const fileName = this.dataset.fileName;
                        showFileViewer(filePath, fileName);
                    });
                }

                // Add edit event listener to the new button
                const editBtn = newRow.querySelector('.edit-btn');
                if (editBtn) {
                    editBtn.addEventListener('click', function() {
                        editEntry(data.id);
                    });
                }
                
                // Add row click listener for MOU details
                newRow.addEventListener('click', function(e) {
                    // Don't trigger if clicking on buttons, checkboxes, or links
                    if (e.target.tagName === 'BUTTON' || 
                        e.target.tagName === 'INPUT' || 
                        e.target.tagName === 'A' ||
                        e.target.closest('button') ||
                        e.target.closest('input') ||
                        e.target.closest('a')) {
                        return;
                    }
                    
                    // Show MOU details
                    if (window.showMouDetails) {
                        window.showMouDetails(data);
                    }
                });
            }
            
            // Function to delete entry with custom modal
            function deleteEntry(id) {
                // Store the ID for the confirmation
                window.pendingDeleteId = id;
                
                // Show the delete confirmation modal
                const deleteModal = document.getElementById('deleteConfirmModal');
                deleteModal.classList.remove('hidden');
            }
            
            // Function to confirm delete
            function confirmDelete() {
                const id = window.pendingDeleteId;
                if (!id) return;
                
                try {
                    const entries = getAllEntries();
                    const filteredEntries = entries.filter(entry => entry.id !== id);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(filteredEntries));
                    
                    // Remove from table
                    const deleteBtn = document.querySelector(`[data-id="${id}"]`);
                    if (deleteBtn) {
                        const row = deleteBtn.closest('tr');
                        row.remove();
                    }
                    
                    // Update pagination display
                    updatePaginationDisplay();
                    
                    // Close modal
                    const deleteModal = document.getElementById('deleteConfirmModal');
                    deleteModal.classList.add('hidden');
                    
                    // Clear pending delete ID
                    window.pendingDeleteId = null;
                    
                    // Show success message
                    showSuccessMessage('MOU/MOA deleted successfully!');
                } catch (error) {
                    showErrorMessage('Failed to delete entry: ' + error.message);
                }
            }
            
            // Function to cancel delete
            function cancelDelete() {
                // Close modal
                const deleteModal = document.getElementById('deleteConfirmModal');
                deleteModal.classList.add('hidden');
                
                // Clear pending delete ID
                window.pendingDeleteId = null;
            }
            
            // Function to update pagination display
            function updatePaginationDisplay() {
                const entries = getAllEntries();
                const totalEntries = entries.length;
                
                const startEntry = totalEntries > 0 ? 1 : 0;
                const endEntry = totalEntries;
                
                // Update the pagination text - use a more specific selector
                const paginationContainer = document.querySelector('.hidden.sm\\:flex-1.sm\\:flex.sm\\:items-center.sm\\:justify-between');
                if (paginationContainer) {
                    const paginationText = paginationContainer.querySelector('div p');
                    if (paginationText) {
                        paginationText.innerHTML = `Showing <span class="font-medium">${startEntry}</span> to <span class="font-medium">${endEntry}</span> of <span class="font-medium">${totalEntries}</span> results`;
                    }
                }
            }
            
            // Make functions globally accessible
            window.confirmDelete = confirmDelete;
            window.cancelDelete = cancelDelete;
            
            // Function to reset form
            function resetForm() {
                document.getElementById('institution').value = '';
                document.getElementById('location').value = '';
                document.getElementById('contact').value = '';
                document.getElementById('term').value = '';
                document.getElementById('sign-date').value = '';
                document.getElementById('end-date').value = '';
                document.getElementById('file-upload').value = '';
                autoStatusText.textContent = 'Will be determined automatically';
                autoStatusText.className = 'text-gray-500 dark:text-gray-400';
                
                // Hide selected file display
                const selectedFileDisplay = document.getElementById('selected-file-display');
                if (selectedFileDisplay) {
                    selectedFileDisplay.classList.add('hidden');
                }
            }
            
            // Function to show error message - Move this before loadFromDatabase
            function showErrorMessage(message) {
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 5000);
            }

            // Function to show success message
            function showSuccessMessage(message) {
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 3000);
            }

            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
                    modal.classList.add('hidden');
                    // Clear selected file display when closing modal
                    updateSelectedFileDisplay(null);
                }
            });

            // File Viewer Modal Functionality
            const fileViewerModal = document.getElementById('fileViewerModal');
            const closeFileViewer = document.getElementById('closeFileViewer');
            const closeFileViewerBtn = document.getElementById('closeFileViewerBtn');
            const fileViewerTitle = document.getElementById('fileViewerTitle');
            const fileViewerSubtitle = document.getElementById('fileViewerSubtitle');
            const fileViewerContent = document.getElementById('fileViewerContent');
            const downloadFile = document.getElementById('downloadFile');
            
            let currentFileData = null;
            
            // Function to show file viewer modal
            function showFileViewer(filePath, fileName) {
                currentFileData = { path: filePath, name: fileName };
                
                // Update modal title and subtitle
                fileViewerTitle.textContent = fileName || 'View File';
                fileViewerSubtitle.textContent = 'Document preview';
                
                // Clear previous content
                fileViewerContent.innerHTML = '';
                
                // Show loading state
                fileViewerContent.innerHTML = `
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                        <p class="text-gray-500 dark:text-gray-400">Loading file...</p>
                    </div>
                `;
                
                // Show modal
                fileViewerModal.classList.remove('hidden');
                
                // Simulate file loading (in a real app, you'd load the actual file)
                setTimeout(() => {
                    loadFileContent(filePath, fileName);
                }, 1000);
            }
            
            // Function to load file content with actual image preview
            function loadFileContent(filePath, fileName) {
                const fileExtension = fileName ? fileName.split('.').pop().toLowerCase() : '';
                
                // Show loading state first
                fileViewerContent.innerHTML = `
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                        <p class="text-gray-500 dark:text-gray-400">Converting file to image...</p>
                    </div>
                `;
                
                // Try to load the actual file and convert to image
                fetch(filePath)
                    .then(response => response.blob())
                    .then(blob => {
                        if (fileExtension === 'pdf') {
                            convertPdfToImage(blob, fileName);
                        } else if (fileExtension === 'docx') {
                            convertDocxToImage(blob, fileName);
                        } else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'].includes(fileExtension)) {
                            showImagePreview(blob, fileName);
                        } else {
                            showGenericPreview(fileName);
                        }
                    })
                    .catch(error => {
                        console.error('Error loading file:', error);
                        showGenericPreview(fileName);
                    });
            }
            
            // Function to convert PDF to image
            function convertPdfToImage(blob, fileName) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const typedarray = new Uint8Array(e.target.result);
                    
                    // Initialize PDF.js
                    pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
                        // Get the first page
                        pdf.getPage(1).then(function(page) {
                            const scale = 1.5;
                            const viewport = page.getViewport({scale: scale});
                            
                            // Create canvas
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            
                            // Render PDF page to canvas
                            const renderContext = {
                                canvasContext: context,
                                viewport: viewport
                            };
                            
                            page.render(renderContext).promise.then(function() {
                                // Convert canvas to image
                                const imageData = canvas.toDataURL('image/png');
                                showImagePreview(imageData, fileName, 'PDF Preview');
                            });
                        });
                    }).catch(function(error) {
                        console.error('PDF conversion error:', error);
                        showGenericPreview(fileName);
                    });
                };
                reader.readAsArrayBuffer(blob);
            }
            
            // Function to convert DOCX to image
            function convertDocxToImage(blob, fileName) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    mammoth.convertToHtml({arrayBuffer: e.target.result})
                        .then(function(result) {
                            // Create a temporary div to render the HTML
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = result.value;
                            tempDiv.style.cssText = `
                                position: absolute;
                                left: -9999px;
                                top: -9999px;
                                width: 800px;
                                padding: 20px;
                                background: white;
                                font-family: Arial, sans-serif;
                                font-size: 14px;
                                line-height: 1.5;
                                color: black;
                            `;
                            document.body.appendChild(tempDiv);
                            
                            // Convert HTML to canvas
                            html2canvas(tempDiv, {
                                width: 800,
                                height: tempDiv.scrollHeight,
                                backgroundColor: '#ffffff'
                            }).then(function(canvas) {
                                const imageData = canvas.toDataURL('image/png');
                                showImagePreview(imageData, fileName, 'Document Preview');
                                document.body.removeChild(tempDiv);
                            }).catch(function(error) {
                                console.error('HTML to canvas conversion error:', error);
                                document.body.removeChild(tempDiv);
                                showGenericPreview(fileName);
                            });
                        })
                        .catch(function(error) {
                            console.error('DOCX conversion error:', error);
                            showGenericPreview(fileName);
                        });
                };
                reader.readAsArrayBuffer(blob);
            }
            
            // Function to show image preview
            function showImagePreview(imageData, fileName, title = 'Image Preview') {
                fileViewerContent.innerHTML = `
                    <div class="w-full h-full flex flex-col">
                        <div class="flex-1 bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow-lg flex items-center justify-center p-4">
                            <img src="${imageData}" alt="${fileName}" class="max-w-full max-h-full object-contain rounded-lg shadow-lg hover:scale-105 transition-transform duration-200">
                        </div>
                        <div class="mt-4 flex justify-center gap-2">
                            <button onclick="downloadCurrentFile()" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-primary bg-primary/10 rounded-lg hover:bg-primary/20">
                                <span class="material-symbols-outlined text-sm">download</span>
                                Download ${fileName.split('.').pop().toUpperCase()}
                            </button>
                        </div>
                    </div>
                `;
            }
            
            // Function to show generic preview for unsupported files
            function showGenericPreview(fileName) {
                fileViewerContent.innerHTML = `
                    <div class="w-full h-full flex flex-col items-center justify-center">
                        <div class="text-center max-w-md">
                            <div class="w-24 h-24 mx-auto mb-4 bg-gray-100 dark:bg-gray-800 rounded-lg flex items-center justify-center">
                                <span class="material-symbols-outlined text-4xl text-gray-400 dark:text-gray-600">description</span>
                            </div>
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-2">${fileName}</h4>
                            <p class="text-gray-500 dark:text-gray-400 mb-4">Preview not available for this file type. You can download the file using the button below.</p>
                        </div>
                    </div>
                `;
            }
            
            // Function to download current file
            function downloadCurrentFile() {
                if (currentFileData && currentFileData.path) {
                    // Create a temporary link to download the file
                    const link = document.createElement('a');
                    link.href = currentFileData.path;
                    link.download = currentFileData.name || 'document';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
            
            // Close file viewer modal
            function closeFileViewerModal() {
                fileViewerModal.classList.add('hidden');
                currentFileData = null;
            }
            
            // Event listeners for file viewer modal
            if (closeFileViewer) {
                closeFileViewer.addEventListener('click', closeFileViewerModal);
            }
            
            if (closeFileViewerBtn) {
                closeFileViewerBtn.addEventListener('click', closeFileViewerModal);
            }
            
            if (downloadFile) {
                downloadFile.addEventListener('click', downloadCurrentFile);
            }
            
            // Close modal when clicking outside
            if (fileViewerModal) {
                fileViewerModal.addEventListener('click', function(e) {
                    if (e.target === fileViewerModal) {
                        closeFileViewerModal();
                    }
                });
            }
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && fileViewerModal && !fileViewerModal.classList.contains('hidden')) {
                    closeFileViewerModal();
                }
            });
            
            // Make downloadCurrentFile globally accessible
            window.downloadCurrentFile = downloadCurrentFile;

            // LocalStorage Database Integration
            const STORAGE_KEY = 'mou_moa_entries';
            
            // Function to get all entries from localStorage
            window.getAllEntries = function() {
                const entries = localStorage.getItem(STORAGE_KEY);
                return entries ? JSON.parse(entries) : [];
            };
            
            // Function to save entry to localStorage
            function saveEntry(entry) {
                const entries = getAllEntries();
                const newEntry = {
                    ...entry,
                    id: Date.now(),
                    created_at: new Date().toISOString()
                };
                entries.unshift(newEntry); // Add to beginning
                localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
                return newEntry;
            }
            
            // Function to save data to localStorage
            async function saveToDatabase(entry) {
                try {
                    const result = saveEntry(entry);
                    return { id: result.id, message: 'Entry saved successfully' };
                } catch (error) {
                    throw new Error('Failed to save data: ' + error.message);
                }
            }
            
            // Function to load data from localStorage
            async function loadFromDatabase() {
                try {
                    allEntries = getAllEntries();
                    currentPage = 1; // Reset to first page
                    displayCurrentPage();
                    updatePaginationDisplay();
                    
                    // Add delete event listeners to existing rows
                    document.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const id = parseInt(this.dataset.id);
                            deleteEntry(id);
                        });
                    });

                    // Add view file event listeners to existing rows
                    document.querySelectorAll('.view-file-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const filePath = this.dataset.filePath;
                            const fileName = this.dataset.fileName;
                            showFileViewer(filePath, fileName);
                        });
                    });
                } catch (error) {
                    console.error('Error loading data:', error);
                    showErrorMessage('Failed to load data from storage');
                }
            }
            
            // Function to display current page entries
            function displayCurrentPage() {
                const tableBody = document.querySelector('tbody');
                tableBody.innerHTML = '';
                
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const currentPageEntries = allEntries.slice(startIndex, endIndex);
                
                currentPageEntries.forEach(entry => {
                    addRowToTable(entry);
                });
            }
            
            // Function to update pagination display
            function updatePaginationDisplay() {
                const totalEntries = allEntries.length;
                const totalPages = Math.ceil(totalEntries / itemsPerPage);
                
                // Update pagination text
                const startEntry = (currentPage - 1) * itemsPerPage + 1;
                const endEntry = Math.min(currentPage * itemsPerPage, totalEntries);
                
                document.getElementById('startEntry').textContent = startEntry;
                document.getElementById('endEntry').textContent = endEntry;
                document.getElementById('totalEntries').textContent = totalEntries;
                
                // Generate pagination buttons
                generatePaginationButtons(totalPages);
                
                // Update mobile buttons
                const prevBtnMobile = document.getElementById('prevBtnMobile');
                const nextBtnMobile = document.getElementById('nextBtnMobile');
                
                if (prevBtnMobile && nextBtnMobile) {
                    prevBtnMobile.disabled = currentPage === 1;
                    nextBtnMobile.disabled = currentPage === totalPages;
                }
            }
            
            // Function to generate pagination buttons
            function generatePaginationButtons(totalPages) {
                const paginationNav = document.getElementById('paginationNav');
                if (!paginationNav) return;
                
                let paginationHTML = '';
                
                // Previous button
                paginationHTML += `
                    <button class="pagination-btn relative inline-flex items-center px-2 py-2 rounded-l-md border border-border-light bg-card-light text-sm font-medium text-text-muted-light hover:bg-gray-50 dark:border-border-dark dark:bg-background-dark/50 dark:text-text-muted-dark dark:hover:bg-card-dark disabled:opacity-50 disabled:cursor-not-allowed" data-page="${currentPage - 1}" ${currentPage === 1 ? 'disabled' : ''}>
                        <span class="sr-only">Previous</span>
                        <span class="material-symbols-outlined text-sm">chevron_left</span>
                    </button>
                `;
                
                // Page numbers
                const startPage = Math.max(1, currentPage - 2);
                const endPage = Math.min(totalPages, currentPage + 2);
                
                if (startPage > 1) {
                    paginationHTML += `
                        <button class="pagination-btn bg-card-light dark:bg-background-dark/50 border-border-light dark:border-border-dark text-text-muted-light dark:text-text-muted-dark hover:bg-gray-50 dark:hover:bg-card-dark relative inline-flex items-center px-4 py-2 border text-sm font-medium" data-page="1">1</button>
                    `;
                    if (startPage > 2) {
                        paginationHTML += `<span class="relative inline-flex items-center px-4 py-2 border border-border-light dark:border-border-dark bg-card-light dark:bg-background-dark/50 text-sm font-medium text-text-muted-light dark:text-text-muted-dark">...</span>`;
                    }
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const isActive = i === currentPage;
                    paginationHTML += `
                        <button class="pagination-btn relative inline-flex items-center px-4 py-2 border text-sm font-medium ${isActive ? 'z-10 bg-primary/10 border-primary text-primary' : 'bg-card-light dark:bg-background-dark/50 border-border-light dark:border-border-dark text-text-muted-light dark:text-text-muted-dark hover:bg-gray-50 dark:hover:bg-card-dark'}" data-page="${i}">${i}</button>
                    `;
                }
                
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        paginationHTML += `<span class="relative inline-flex items-center px-4 py-2 border border-border-light dark:border-border-dark bg-card-light dark:bg-background-dark/50 text-sm font-medium text-text-muted-light dark:text-text-muted-dark">...</span>`;
                    }
                    paginationHTML += `
                        <button class="pagination-btn bg-card-light dark:bg-background-dark/50 border-border-light dark:border-border-dark text-text-muted-light dark:text-text-muted-dark hover:bg-gray-50 dark:hover:bg-card-dark relative inline-flex items-center px-4 py-2 border text-sm font-medium" data-page="${totalPages}">${totalPages}</button>
                    `;
                }
                
                // Next button
                paginationHTML += `
                    <button class="pagination-btn relative inline-flex items-center px-2 py-2 rounded-r-md border border-border-light bg-card-light text-sm font-medium text-text-muted-light hover:bg-gray-50 dark:border-border-dark dark:bg-background-dark/50 dark:text-text-muted-dark dark:hover:bg-card-dark disabled:opacity-50 disabled:cursor-not-allowed" data-page="${currentPage + 1}" ${currentPage === totalPages ? 'disabled' : ''}>
                        <span class="sr-only">Next</span>
                        <span class="material-symbols-outlined text-sm">chevron_right</span>
                    </button>
                `;
                
                paginationNav.innerHTML = paginationHTML;
                
                // Add event listeners to pagination buttons
                document.querySelectorAll('.pagination-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const page = parseInt(this.dataset.page);
                        if (page && page !== currentPage && page >= 1 && page <= totalPages) {
                            goToPage(page);
                        }
                    });
                });
            }
            
            // Function to go to a specific page
            function goToPage(page) {
                currentPage = page;
                displayCurrentPage();
                updatePaginationDisplay();
            }
            
            // Update the addRowToTable function to not automatically update pagination
            function addRowToTable(data) {
                const tableBody = document.querySelector('tbody');
                const newRow = document.createElement('tr');
                
                // Determine status badge class
                let statusBadgeClass = '';
                if (data.status === 'Active') {
                    statusBadgeClass = 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300';
                } else if (data.status === 'Expired') {
                    statusBadgeClass = 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300';
                } else if (data.status === 'Expires Soon') {
                    statusBadgeClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300';
                } else {
                    statusBadgeClass = 'bg-gray-100 text-gray-800 dark:bg-gray-900/50 dark:text-gray-300';
                }
                
                newRow.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <input type="checkbox" class="row-checkbox w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary dark:focus:ring-primary dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" data-id="${data.id}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-text-light dark:text-text-dark text-left">${data.institution}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted-light dark:text-text-muted-dark text-center">${data.location}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted-light dark:text-text-muted-dark text-left">${data.contact_email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted-light dark:text-text-muted-dark text-center">${data.term}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted-light dark:text-text-muted-dark text-center">${data.sign_date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-text-muted-light dark:text-text-muted-dark text-center">${data.end_date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusBadgeClass}">${data.status}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                        ${data.file_name ? 
                            `<button class="view-file-btn text-primary hover:text-primary/80 dark:text-primary-400 dark:hover:text-primary-300 flex items-center gap-1 mx-auto" data-file-path="${data.file_path}" data-file-name="${data.file_name}" title="View File">
                                <span class="material-symbols-outlined text-sm">visibility</span>
                                <span>View</span>
                            </button>` : 
                            `<span class="text-gray-400 dark:text-gray-500 text-sm">No file</span>`
                        }
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                        <div class="flex items-center justify-center gap-2">
                            <button class="edit-btn text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-200" data-id="${data.id}" title="Edit MOU/MOA">
                                <img src="assets/images/edit.png" alt="Edit" class="w-4 h-4">
                            </button>
                            <button class="delete-btn text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-200" data-id="${data.id}" title="Delete MOU/MOA">
                                <img src="assets/images/trash.png" alt="Delete" class="w-4 h-4">
                            </button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(newRow);
                
                // Add delete event listener to the new button
                const deleteBtn = newRow.querySelector('.delete-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function() {
                        deleteEntry(data.id);
                    });
                }

                // Add view file event listener to the new button (only if it exists)
                const viewFileBtn = newRow.querySelector('.view-file-btn');
                if (viewFileBtn) {
                    viewFileBtn.addEventListener('click', function() {
                        const filePath = this.dataset.filePath;
                        const fileName = this.dataset.fileName;
                        showFileViewer(filePath, fileName);
                    });
                }

                // Add edit event listener to the new button
                const editBtn = newRow.querySelector('.edit-btn');
                if (editBtn) {
                    editBtn.addEventListener('click', function() {
                        editEntry(data.id);
                    });
                }
                
                // Add row click listener for MOU details
                newRow.addEventListener('click', function(e) {
                    // Don't trigger if clicking on buttons, checkboxes, or links
                    if (e.target.tagName === 'BUTTON' || 
                        e.target.tagName === 'INPUT' || 
                        e.target.tagName === 'A' ||
                        e.target.closest('button') ||
                        e.target.closest('input') ||
                        e.target.closest('a')) {
                        return;
                    }
                    
                    // Show MOU details
                    if (window.showMouDetails) {
                        window.showMouDetails(data);
                    }
                });
            }
            
            // Update the confirmDelete function to refresh pagination
            function confirmDelete() {
                const id = window.pendingDeleteId;
                if (!id) return;
                
                try {
                    const entries = getAllEntries();
                    const filteredEntries = entries.filter(entry => entry.id !== id);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(filteredEntries));
                    
                    // Refresh the data and pagination
                    loadFromDatabase();
                    
                    // Close modal
                    const deleteModal = document.getElementById('deleteConfirmModal');
                    deleteModal.classList.add('hidden');
                    
                    // Clear pending delete ID
                    window.pendingDeleteId = null;
                    
                    // Show success message
                    showSuccessMessage('MOU/MOA deleted successfully!');
                } catch (error) {
                    showErrorMessage('Failed to delete entry: ' + error.message);
                }
            }
            
            // Update the save button handler to refresh pagination
            if (saveBtn) {
                saveBtn.addEventListener('click', async function() {
                    // ... existing save logic ...
                    
                    // After successful save, refresh pagination
                    loadFromDatabase();
                });
            }
            
            // Add mobile pagination event listeners
            const prevBtnMobile = document.getElementById('prevBtnMobile');
            const nextBtnMobile = document.getElementById('nextBtnMobile');
            
            if (prevBtnMobile) {
                prevBtnMobile.addEventListener('click', function() {
                    if (currentPage > 1) {
                        goToPage(currentPage - 1);
                    }
                });
            }
            
            if (nextBtnMobile) {
                nextBtnMobile.addEventListener('click', function() {
                    const totalPages = Math.ceil(allEntries.length / itemsPerPage);
                    if (currentPage < totalPages) {
                        goToPage(currentPage + 1);
                    }
                });
            }
            
            // Load existing data when page loads
            loadFromDatabase();

            // Function to edit entry
            function editEntry(id) {
                // Get the entry data from localStorage
                const entries = getAllEntries();
                const entryToEdit = entries.find(entry => entry.id === id);
                
                if (!entryToEdit) {
                    showErrorMessage('Entry not found');
                    return;
                }
                
                // Store the ID for editing
                window.editingEntryId = id;
                
                // Pre-fill the modal with existing data
                document.getElementById('institution').value = entryToEdit.institution || '';
                document.getElementById('location').value = entryToEdit.location || '';
                document.getElementById('contact').value = entryToEdit.contact_email || '';
                document.getElementById('term').value = entryToEdit.term || '';
                document.getElementById('sign-date').value = entryToEdit.sign_date || '';
                document.getElementById('end-date').value = entryToEdit.end_date || '';
                
                // Update status display
                const status = determineStatus(entryToEdit.end_date);
                const autoStatusText = document.getElementById('autoStatusText');
                autoStatusText.textContent = status;
                
                // Update text color based on status
                if (status === 'Active') {
                    autoStatusText.className = 'text-green-600 dark:text-green-400';
                } else if (status === 'Expired') {
                    autoStatusText.className = 'text-red-600 dark:text-red-400';
                } else if (status === 'Expires Soon') {
                    autoStatusText.className = 'text-yellow-600 dark:text-yellow-400';
                } else {
                    autoStatusText.className = 'text-gray-500 dark:text-gray-400';
                }
                
                // Update modal title and button text
                const modalTitle = document.querySelector('#addFileModal h3');
                const saveBtn = document.getElementById('saveBtn');
                modalTitle.textContent = 'Edit MOU/MOA File';
                saveBtn.textContent = 'Update';
                
                // Show the modal
                const modal = document.getElementById('addFileModal');
                modal.classList.remove('hidden');
            }
        });
    </script>

    <!-- Sort functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sortBtn = document.getElementById('sortBtn');
            const sortDropdown = document.getElementById('sortDropdown');
            const sortText = document.getElementById('sortText');
            const sortOptions = document.querySelectorAll('.sort-option');
            const clearSortBtn = document.getElementById('clearSort');
            const tableBody = document.querySelector('tbody');
            
            let currentSort = null;
            let currentDirection = null;
            
            // Toggle dropdown
            sortBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                sortDropdown.classList.toggle('hidden');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!sortBtn.contains(e.target) && !sortDropdown.contains(e.target)) {
                    sortDropdown.classList.add('hidden');
                }
            });
            
            // Sort function
            function sortTable(column, direction) {
                const rows = Array.from(tableBody.querySelectorAll('tr'));
                
                rows.sort((a, b) => {
                    let aValue, bValue;
                    
                    switch(column) {
                        case 'institution':
                            aValue = a.cells[0].textContent.trim();
                            bValue = b.cells[0].textContent.trim();
                            break;
                        case 'location':
                            aValue = a.cells[1].textContent.trim();
                            bValue = b.cells[1].textContent.trim();
                            break;
                        case 'signDate':
                            aValue = new Date(a.cells[4].textContent.trim());
                            bValue = new Date(b.cells[4].textContent.trim());
                            break;
                        case 'endDate':
                            aValue = new Date(a.cells[5].textContent.trim());
                            bValue = new Date(b.cells[5].textContent.trim());
                            break;
                        case 'status':
                            aValue = a.cells[6].textContent.trim(); // Status column (moved from position 7 to 6)
                            bValue = b.cells[6].textContent.trim(); // Status column (moved from position 7 to 6)
                            break;
                        default:
                            return 0;
                    }
                    
                    if (column === 'signDate' || column === 'endDate') {
                        return direction === 'asc' ? aValue - bValue : bValue - aValue;
                    } else {
                        if (direction === 'asc') {
                            return aValue.localeCompare(bValue);
                        } else {
                            return bValue.localeCompare(aValue);
                        }
                    }
                });
                
                // Clear table body and re-append sorted rows
                tableBody.innerHTML = '';
                rows.forEach(row => tableBody.appendChild(row));
                
                // Update current sort
                currentSort = column;
                currentDirection = direction;
                
                // Update UI
                updateSortUI();
            }
            
            // Update sort UI indicators
            function updateSortUI() {
                // Clear all indicators
                document.querySelectorAll('.sort-indicator').forEach(indicator => {
                    indicator.classList.add('hidden');
                });
                
                // Show current sort indicator
                if (currentSort && currentDirection) {
                    const activeOption = document.querySelector(`[data-sort="${currentSort}"][data-direction="${currentDirection}"]`);
                    if (activeOption) {
                        activeOption.querySelector('.sort-indicator').classList.remove('hidden');
                    }
                }
                
                // Update sort button text (without arrows)
                if (currentSort && currentDirection) {
                    const sortLabels = {
                        'institution': 'Institution',
                        'location': 'Location', 
                        'signDate': 'Sign Date',
                        'endDate': 'End Date',
                        'status': 'Status'
                    };
                    sortText.textContent = `${sortLabels[currentSort]}`;
                } else {
                    sortText.textContent = 'Sort';
                }
            }
            
            // Handle sort option clicks
            sortOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const column = this.dataset.sort;
                    const direction = this.dataset.direction;
                    sortTable(column, direction);
                    sortDropdown.classList.add('hidden');
                });
            });
            
            // Handle clear sort
            clearSortBtn.addEventListener('click', function() {
                // Reset to original order (you might want to store original order)
                location.reload(); // Simple way to reset, or implement original order storage
                sortDropdown.classList.add('hidden');
            });
        });
    </script>

    <!-- Filter functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const filterBtn = document.getElementById('filterBtn');
            const filterDropdown = document.getElementById('filterDropdown');
            const filterOptions = document.querySelectorAll('.filter-option');
            const clearFilterBtn = document.getElementById('clearFilter');
            const institutionFilter = document.getElementById('institutionFilter');
            const signDateFrom = document.getElementById('signDateFrom');
            const signDateTo = document.getElementById('signDateTo');
            const endDateFrom = document.getElementById('endDateFrom');
            const endDateTo = document.getElementById('endDateTo');
            const filterText = document.getElementById('filterText');
            
            // Toggle dropdown
            filterBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                filterDropdown.classList.toggle('hidden');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!filterBtn.contains(e.target) && !filterDropdown.contains(e.target)) {
                    filterDropdown.classList.add('hidden');
                }
            });
            
            // Advanced filter functionality
            let currentFilter = { 
                status: 'all', 
                institution: '',
                signDateFrom: '',
                signDateTo: '',
                endDateFrom: '',
                endDateTo: '',
                term: 'all'
            };
            
            // Function to parse term duration
            function parseTermDuration(termText) {
                if (!termText) return 'unknown';
                
                const term = termText.toLowerCase();
                const yearMatch = term.match(/(\d+)\s*year/i);
                const monthMatch = term.match(/(\d+)\s*month/i);
                const dayMatch = term.match(/(\d+)\s*day/i);
                
                if (yearMatch) {
                    const years = parseInt(yearMatch[1]);
                    if (years <= 1) return 'short';
                    if (years <= 3) return 'medium';
                    return 'long';
                } else if (monthMatch) {
                    const months = parseInt(monthMatch[1]);
                    if (months <= 12) return 'short';
                    return 'medium';
                } else if (dayMatch) {
                    return 'short';
                }
                
                return 'unknown';
            }
            
            // Function to compare dates
            function isDateInRange(dateStr, fromDate, toDate) {
                if (!dateStr) return false;
                const date = new Date(dateStr);
                const from = fromDate ? new Date(fromDate) : null;
                const to = toDate ? new Date(toDate) : null;
                
                if (from && date < from) return false;
                if (to && date > to) return false;
                return true;
            }
            
            // Function to apply filters
            function applyFilters() {
                const tableBody = document.querySelector('tbody');
                const rows = Array.from(tableBody.querySelectorAll('tr'));
                
                rows.forEach(row => {
                    let showRow = true;
                    
                    // Filter by status
                    if (currentFilter.status !== 'all') {
                        const statusCell = row.cells[7]; // Status column (index 7)
                        const statusSpan = statusCell.querySelector('span');
                        const statusText = statusSpan ? statusSpan.textContent.trim() : statusCell.textContent.trim();
                        if (statusText !== currentFilter.status) {
                            showRow = false;
                        }
                    }
                    
                    // Filter by institution
                    if (currentFilter.institution) {
                        const institutionCell = row.cells[1]; // Institution column (index 1)
                        const institutionText = institutionCell.textContent.trim().toLowerCase();
                        if (!institutionText.includes(currentFilter.institution.toLowerCase())) {
                            showRow = false;
                        }
                    }
                    
                    // Filter by sign date range
                    if (currentFilter.signDateFrom || currentFilter.signDateTo) {
                        const signDateCell = row.cells[5]; // Sign Date column (index 5)
                        const signDateText = signDateCell.textContent.trim();
                        if (!isDateInRange(signDateText, currentFilter.signDateFrom, currentFilter.signDateTo)) {
                            showRow = false;
                        }
                    }
                    
                    // Filter by end date range
                    if (currentFilter.endDateFrom || currentFilter.endDateTo) {
                        const endDateCell = row.cells[6]; // End Date column (index 6)
                        const endDateText = endDateCell.textContent.trim();
                        if (!isDateInRange(endDateText, currentFilter.endDateFrom, currentFilter.endDateTo)) {
                            showRow = false;
                        }
                    }
                    
                    // Filter by term duration
                    if (currentFilter.term !== 'all') {
                        const termCell = row.cells[4]; // Term column (index 4)
                        const termText = termCell.textContent.trim();
                        const termDuration = parseTermDuration(termText);
                        if (termDuration !== currentFilter.term) {
                            showRow = false;
                        }
                    }
                    
                    // Show/hide row
                    row.style.display = showRow ? '' : 'none';
                });
            }
            
            // Function to update filter UI
            function updateFilterUI() {
                // Clear all indicators
                document.querySelectorAll('.filter-indicator').forEach(indicator => {
                    indicator.classList.add('hidden');
                });
                
                // Show current filter indicators
                Object.keys(currentFilter).forEach(filterType => {
                    if (filterType === 'status' || filterType === 'term') {
                        const value = currentFilter[filterType];
                        if (value !== 'all') {
                            const activeOption = document.querySelector(`[data-filter="${filterType}"][data-value="${value}"]`);
                    if (activeOption) {
                        activeOption.querySelector('.filter-indicator').classList.remove('hidden');
                    }
                } else {
                            const allOption = document.querySelector(`[data-filter="${filterType}"][data-value="all"]`);
                    if (allOption) {
                        allOption.querySelector('.filter-indicator').classList.remove('hidden');
                    }
                }
                    }
                });
                
                // Update filter button text
                const activeFilters = [];
                if (currentFilter.status !== 'all') activeFilters.push(currentFilter.status);
                if (currentFilter.institution) activeFilters.push('Institution');
                if (currentFilter.signDateFrom || currentFilter.signDateTo) activeFilters.push('Sign Date');
                if (currentFilter.endDateFrom || currentFilter.endDateTo) activeFilters.push('End Date');
                if (currentFilter.term !== 'all') activeFilters.push('Term');
                
                if (activeFilters.length > 0) {
                    filterText.textContent = `Filter (${activeFilters.length})`;
                } else {
                    filterText.textContent = 'Filter';
                }
            }
            
            // Handle filter option clicks
            filterOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const filter = this.dataset.filter;
                    const value = this.dataset.value;
                    
                    if (filter === 'status') {
                        currentFilter.status = value;
                    } else if (filter === 'term') {
                        currentFilter.term = value;
                    }
                    
                    applyFilters();
                    updateFilterUI();
                    filterDropdown.classList.add('hidden');
                });
            });
            
            // Handle text input filters
            institutionFilter.addEventListener('input', function() {
                currentFilter.institution = this.value;
                applyFilters();
                updateFilterUI();
            });
            
            // Handle date range filters
            signDateFrom.addEventListener('change', function() {
                currentFilter.signDateFrom = this.value;
                applyFilters();
                updateFilterUI();
            });
            
            signDateTo.addEventListener('change', function() {
                currentFilter.signDateTo = this.value;
                applyFilters();
                updateFilterUI();
            });
            
            endDateFrom.addEventListener('change', function() {
                currentFilter.endDateFrom = this.value;
                applyFilters();
                updateFilterUI();
            });
            
            endDateTo.addEventListener('change', function() {
                currentFilter.endDateTo = this.value;
                applyFilters();
                updateFilterUI();
            });
            
            // Handle clear filter
            clearFilterBtn.addEventListener('click', function() {
                currentFilter = { 
                    status: 'all', 
                    institution: '',
                    signDateFrom: '',
                    signDateTo: '',
                    endDateFrom: '',
                    endDateTo: '',
                    term: 'all'
                };
                
                // Clear all input fields
                institutionFilter.value = '';
                signDateFrom.value = '';
                signDateTo.value = '';
                endDateFrom.value = '';
                endDateTo.value = '';
                
                applyFilters();
                updateFilterUI();
                filterDropdown.classList.add('hidden');
            });
            
            // Initialize filter UI
            updateFilterUI();
        });
    </script>

    <!-- Delete Confirmation Modal Event Listeners -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const deleteConfirmModal = document.getElementById('deleteConfirmModal');
            const cancelDeleteBtn = document.getElementById('cancelDelete');
            const confirmDeleteBtn = document.getElementById('confirmDelete');
            
            // Event listeners for delete confirmation modal
            if (cancelDeleteBtn) {
                cancelDeleteBtn.addEventListener('click', function() {
                    if (window.cancelDelete) {
                        window.cancelDelete();
                    }
                });
            }
            
            if (confirmDeleteBtn) {
                confirmDeleteBtn.addEventListener('click', function() {
                    if (window.confirmDelete) {
                        window.confirmDelete();
                    }
                });
            }
            
            // Close modal when clicking outside
            if (deleteConfirmModal) {
                deleteConfirmModal.addEventListener('click', function(e) {
                    if (e.target === deleteConfirmModal) {
                        if (window.cancelDelete) {
                            window.cancelDelete();
                        }
                    }
                });
            }
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && deleteConfirmModal && !deleteConfirmModal.classList.contains('hidden')) {
                    if (window.cancelDelete) {
                        window.cancelDelete();
                    }
                }
            });
        });
    </script>

    <!-- Notification System -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.getElementById('notificationDropdown');
            const notificationBadge = document.getElementById('notificationBadge');
            const notificationList = document.getElementById('notificationList');
            const noNotifications = document.getElementById('noNotifications');
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            const viewAllNotifications = document.getElementById('viewAllNotifications');
            
            // Notification storage key
            const NOTIFICATIONS_KEY = 'mou_notifications';
            
            // Initialize notification system
            initNotificationSystem();
            
            // Toggle notification dropdown
            notificationBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                notificationDropdown.classList.toggle('hidden');
                if (!notificationDropdown.classList.contains('hidden')) {
                    updateNotificationDisplay();
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!notificationBtn.contains(e.target) && !notificationDropdown.contains(e.target)) {
                    notificationDropdown.classList.add('hidden');
                }
            });
            
            // Mark all notifications as read
            markAllReadBtn.addEventListener('click', function() {
                markAllNotificationsAsRead();
            });
            
            // View all notifications
            viewAllNotifications.addEventListener('click', function() {
                showAllNotificationsModal();
            });
            
            // Initialize notification system
            function initNotificationSystem() {
                // Check for expiry alerts and renewal reminders
                checkExpiryAlerts();
                checkRenewalReminders();
                
                // Update notification badge
                updateNotificationBadge();
                
                // Set up periodic checks (every hour)
                setInterval(function() {
                    checkExpiryAlerts();
                    checkRenewalReminders();
                    updateNotificationBadge();
                }, 60 * 60 * 1000); // 1 hour
            }
            
            // Check for expiry alerts
            function checkExpiryAlerts() {
                const entries = getAllEntries();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                entries.forEach(entry => {
                    if (entry.end_date) {
                        const endDate = new Date(entry.end_date);
                        endDate.setHours(0, 0, 0, 0);
                        
                        // Calculate days until expiry (negative means expired)
                        const daysUntilExpiry = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                        
                        // CRITICAL ALERTS for expired/lapsed agreements
                        if (daysUntilExpiry < 0) {
                            // Agreement has expired/lapsed
                            const daysExpired = Math.abs(daysUntilExpiry);
                            let title, message;
                            
                            if (daysExpired === 1) {
                                title = 'CRITICAL: MOU/MOA Expired Yesterday';
                                message = `${entry.institution} agreement expired yesterday - IMMEDIATE ACTION REQUIRED`;
                            } else if (daysExpired <= 7) {
                                title = 'CRITICAL: MOU/MOA Expired';
                                message = `${entry.institution} agreement expired ${daysExpired} days ago - URGENT RENEWAL NEEDED`;
                            } else {
                                title = 'CRITICAL: MOU/MOA Lapsed';
                                message = `${entry.institution} agreement lapsed ${daysExpired} days ago - CRITICAL RENEWAL REQUIRED`;
                            }
                            
                            createNotification({
                                id: `expired_critical_${entry.id}`,
                                type: 'expired_critical',
                                title: title,
                                message: message,
                                entryId: entry.id,
                                priority: 'critical',
                                timestamp: new Date().toISOString()
                            });
                        } else if (daysUntilExpiry === 0) {
                            // Expires today
                            createNotification({
                                id: `expires_today_${entry.id}`,
                                type: 'expires_today',
                                title: 'CRITICAL: MOU/MOA Expires Today',
                                message: `${entry.institution} agreement expires today - IMMEDIATE ACTION REQUIRED`,
                                entryId: entry.id,
                                priority: 'critical',
                                timestamp: new Date().toISOString()
                            });
                        } else if (daysUntilExpiry === 1) {
                            // Critical alert - 1 day before deadline
                            createNotification({
                                id: `critical_expires_tomorrow_${entry.id}`,
                                type: 'critical_expires_soon',
                                title: 'CRITICAL: MOU/MOA Expires Tomorrow',
                                message: `${entry.institution} agreement expires tomorrow - URGENT ACTION REQUIRED`,
                                entryId: entry.id,
                                priority: 'critical',
                                timestamp: new Date().toISOString()
                            });
                        } else if (daysUntilExpiry === 30) {
                            // Regular alert - 1 month before expiry
                            createNotification({
                                id: `expires_month_${entry.id}`,
                                type: 'expires_soon',
                                title: 'MOU/MOA Expires in 1 Month',
                                message: `${entry.institution} agreement expires in 30 days - consider renewal`,
                                entryId: entry.id,
                                priority: 'medium',
                                timestamp: new Date().toISOString()
                            });
                        }
                    }
                });
            }
            
            // Check for renewal reminders
            function checkRenewalReminders() {
                const entries = getAllEntries();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                entries.forEach(entry => {
                    if (entry.end_date) {
                        const endDate = new Date(entry.end_date);
                        endDate.setHours(0, 0, 0, 0);
                        
                        // Calculate days until expiry
                        const daysUntilExpiry = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                        
                        // Create renewal reminders for long-term planning (3 months before)
                        if (daysUntilExpiry === 90) {
                            // Check if we haven't already created this reminder
                            const reminderId = `renewal_reminder_${entry.id}`;
                            if (!getNotificationById(reminderId)) {
                                createNotification({
                                    id: reminderId,
                                    type: 'renewal_reminder',
                                    title: 'Consider Renewal Planning',
                                    message: `${entry.institution} agreement expires in 90 days - start renewal planning`,
                                    entryId: entry.id,
                                    priority: 'low',
                                    timestamp: new Date().toISOString()
                                });
                            }
                        }
                    }
                });
            }
            
            // Create a new notification
            function createNotification(notification) {
                const notifications = getNotifications();
                
                // Check if notification already exists
                const existingIndex = notifications.findIndex(n => n.id === notification.id);
                if (existingIndex !== -1) {
                    // Update existing notification
                    notifications[existingIndex] = notification;
                } else {
                    // Add new notification
                    notifications.unshift(notification);
                }
                
                // Keep only last 50 notifications
                if (notifications.length > 50) {
                    notifications.splice(50);
                }
                
                localStorage.setItem(NOTIFICATIONS_KEY, JSON.stringify(notifications));
                updateNotificationBadge();
            }
            
            // Get all notifications
            function getNotifications() {
                const notifications = localStorage.getItem(NOTIFICATIONS_KEY);
                return notifications ? JSON.parse(notifications) : [];
            }
            
            // Get notification by ID
            function getNotificationById(id) {
                const notifications = getNotifications();
                return notifications.find(n => n.id === id);
            }
            
            // Mark notification as read
            function markNotificationAsRead(id) {
                const notifications = getNotifications();
                const notification = notifications.find(n => n.id === id);
                if (notification) {
                    notification.read = true;
                    localStorage.setItem(NOTIFICATIONS_KEY, JSON.stringify(notifications));
                    updateNotificationBadge();
                    updateNotificationDisplay();
                }
            }
            
            // Mark all notifications as read
            function markAllNotificationsAsRead() {
                const notifications = getNotifications();
                notifications.forEach(notification => {
                    notification.read = true;
                });
                localStorage.setItem(NOTIFICATIONS_KEY, JSON.stringify(notifications));
                updateNotificationBadge();
                updateNotificationDisplay();
            }
            
            // Update notification badge
            function updateNotificationBadge() {
                const notifications = getNotifications();
                const unreadCount = notifications.filter(n => !n.read).length;
                
                if (unreadCount > 0) {
                    notificationBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    notificationBadge.classList.remove('hidden');
                } else {
                    notificationBadge.classList.add('hidden');
                }
            }
            
            // Update notification display
            function updateNotificationDisplay() {
                const notifications = getNotifications();
                
                if (notifications.length === 0) {
                    noNotifications.classList.remove('hidden');
                    return;
                }
                
                noNotifications.classList.add('hidden');
                
                // Sort notifications by priority and timestamp
                const sortedNotifications = notifications.sort((a, b) => {
                    const priorityOrder = { critical: 4, high: 3, medium: 2, low: 1 };
                    if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                        return priorityOrder[b.priority] - priorityOrder[a.priority];
                    }
                    return new Date(b.timestamp) - new Date(a.timestamp);
                });
                
                // Display only recent notifications (last 10)
                const recentNotifications = sortedNotifications.slice(0, 10);
                
                notificationList.innerHTML = recentNotifications.map(notification => {
                    const timeAgo = getTimeAgo(new Date(notification.timestamp));
                    const priorityColor = getPriorityColor(notification.priority);
                    const readClass = notification.read ? 'opacity-60' : '';
                    
                    return `
                        <div class="notification-item p-4 border-b border-gray-100 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50 cursor-pointer ${readClass}" data-id="${notification.id}">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center ${priorityColor}">
                                        <span class="material-symbols-outlined text-white text-sm">
                                            ${getNotificationIcon(notification.type)}
                                        </span>
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between">
                                        <h4 class="text-sm font-medium text-gray-900 dark:text-white truncate">
                                            ${notification.title}
                                        </h4>
                                        <span class="text-xs text-gray-500 dark:text-gray-400">${timeAgo}</span>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">
                                        ${notification.message}
                                    </p>
                                </div>
                                ${!notification.read ? '<div class="w-2 h-2 bg-primary rounded-full flex-shrink-0 mt-2"></div>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Add click handlers to notification items
                document.querySelectorAll('.notification-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const notificationId = this.dataset.id;
                        markNotificationAsRead(notificationId);
                        
                        // Could navigate to the specific MOU/MOA entry
                        const notification = getNotificationById(notificationId);
                        if (notification && notification.entryId) {
                            // Scroll to the entry in the table or highlight it
                            highlightEntry(notification.entryId);
                        }
                    });
                });
            }
            
            // Get priority color
            function getPriorityColor(priority) {
                switch (priority) {
                    case 'critical': return 'bg-red-600';
                    case 'high': return 'bg-red-500';
                    case 'medium': return 'bg-yellow-500';
                    case 'low': return 'bg-blue-500';
                    default: return 'bg-gray-500';
                }
            }
            
            // Get notification icon
            function getNotificationIcon(type) {
                switch (type) {
                    case 'expired_critical': return 'error';
                    case 'expires_today': return 'warning';
                    case 'critical_expires_soon': return 'warning';
                    case 'expires_soon': return 'schedule';
                    case 'renewal_reminder': return 'refresh';
                    default: return 'info';
                }
            }
            
            // Get time ago string
            function getTimeAgo(date) {
                const now = new Date();
                const diffInSeconds = Math.floor((now - date) / 1000);
                
                if (diffInSeconds < 60) return 'Just now';
                if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
                if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
                if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}d ago`;
                return date.toLocaleDateString();
            }
            
            // Highlight entry in table
            function highlightEntry(entryId) {
                const checkbox = document.querySelector(`.row-checkbox[data-id="${entryId}"]`);
                if (checkbox) {
                    const row = checkbox.closest('tr');
                    if (row) {
                        // Scroll to the row
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // Highlight the row temporarily
                        row.classList.add('bg-yellow-100', 'dark:bg-yellow-900/20');
                        setTimeout(() => {
                            row.classList.remove('bg-yellow-100', 'dark:bg-yellow-900/20');
                        }, 3000);
                    }
                }
            }
            
            // Make functions globally accessible
            window.checkExpiryAlerts = checkExpiryAlerts;
            window.checkRenewalReminders = checkRenewalReminders;
            window.updateNotificationBadge = updateNotificationBadge;
            
            // Show all notifications modal
            function showAllNotificationsModal() {
                // Create modal if it doesn't exist
                let allNotificationsModal = document.getElementById('allNotificationsModal');
                if (!allNotificationsModal) {
                    createAllNotificationsModal();
                    allNotificationsModal = document.getElementById('allNotificationsModal');
                }
                
                // Update modal content
                updateAllNotificationsModal();
                
                // Show modal
                allNotificationsModal.classList.remove('hidden');
                
                // Close the dropdown
                notificationDropdown.classList.add('hidden');
            }
            
            // Create the all notifications modal
            function createAllNotificationsModal() {
                const modalHTML = `
                    <div id="allNotificationsModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
                        <div class="w-full max-w-4xl bg-white dark:bg-background-dark rounded-xl shadow-2xl m-4 flex flex-col max-h-[90vh]">
                            <!-- Modal Header -->
                            <div class="p-6 border-b border-gray-200 dark:border-gray-800 flex-shrink-0">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-xl font-semibold text-gray-900 dark:text-white">All Notifications</h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Manage your MOU/MOA notifications</p>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <button id="markAllReadModalBtn" class="px-4 py-2 text-sm font-medium text-primary bg-primary/10 rounded-lg hover:bg-primary/20">
                                            Mark All Read
                                        </button>
                                        <button id="closeAllNotificationsModal" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500 dark:text-gray-400">
                                            <span class="material-symbols-outlined">close</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Filter Tabs -->
                            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-800 flex-shrink-0">
                                <div class="flex space-x-1 bg-gray-100 dark:bg-gray-800 rounded-lg p-1">
                                    <button class="notification-tab px-4 py-2 text-sm font-medium rounded-md transition-colors" data-filter="all">
                                        All
                                    </button>
                                    <button class="notification-tab px-4 py-2 text-sm font-medium rounded-md transition-colors" data-filter="critical">
                                        Critical
                                    </button>
                                    <button class="notification-tab px-4 py-2 text-sm font-medium rounded-md transition-colors" data-filter="high">
                                        High
                                    </button>
                                    <button class="notification-tab px-4 py-2 text-sm font-medium rounded-md transition-colors" data-filter="medium">
                                        Medium
                                    </button>
                                    <button class="notification-tab px-4 py-2 text-sm font-medium rounded-md transition-colors" data-filter="low">
                                        Low
                                    </button>
                                    <button class="notification-tab px-4 py-2 text-sm font-medium rounded-md transition-colors" data-filter="unread">
                                        Unread
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Notifications List -->
                            <div id="allNotificationsList" class="flex-1 overflow-y-auto p-6">
                                <!-- Notifications will be populated here -->
                            </div>
                            
                            <!-- Modal Footer -->
                            <div class="p-6 border-t border-gray-200 dark:border-gray-800 flex-shrink-0">
                                <div class="flex items-center justify-between">
                                    <div class="text-sm text-gray-500 dark:text-gray-400">
                                        <span id="notificationsCount">0</span> notifications
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <button id="clearOldNotifications" class="px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                                            Clear Old
                                        </button>
                                        <button id="closeAllNotificationsModalBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-background-dark/50 dark:text-gray-300 dark:border-gray-700 dark:hover:bg-gray-800">
                                            Close
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Add event listeners for the modal
                setupAllNotificationsModalEvents();
            }
            
            // Setup event listeners for the all notifications modal
            function setupAllNotificationsModalEvents() {
                const modal = document.getElementById('allNotificationsModal');
                const closeBtn = document.getElementById('closeAllNotificationsModal');
                const closeBtn2 = document.getElementById('closeAllNotificationsModalBtn');
                const markAllReadBtn = document.getElementById('markAllReadModalBtn');
                const clearOldBtn = document.getElementById('clearOldNotifications');
                const tabs = document.querySelectorAll('.notification-tab');
                
                // Close modal
                closeBtn.addEventListener('click', closeAllNotificationsModal);
                closeBtn2.addEventListener('click', closeAllNotificationsModal);
                
                // Close modal when clicking outside
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeAllNotificationsModal();
                    }
                });
                
                // Close modal with Escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) {
                        closeAllNotificationsModal();
                    }
                });
                
                // Mark all as read
                markAllReadBtn.addEventListener('click', function() {
                    markAllNotificationsAsRead();
                    updateAllNotificationsModal();
                });
                
                // Clear old notifications
                clearOldBtn.addEventListener('click', function() {
                    clearOldNotifications();
                });
                
                // Tab filtering
                tabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        // Update active tab
                        tabs.forEach(t => t.classList.remove('bg-white', 'dark:bg-gray-700', 'text-gray-900', 'dark:text-white', 'shadow-sm'));
                        tabs.forEach(t => t.classList.add('text-gray-600', 'dark:text-gray-400'));
                        
                        this.classList.remove('text-gray-600', 'dark:text-gray-400');
                        this.classList.add('bg-white', 'dark:bg-gray-700', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                        
                        // Filter notifications
                        const filter = this.dataset.filter;
                        filterAllNotifications(filter);
                    });
                });
                
                // Set default active tab
                tabs[0].classList.remove('text-gray-600', 'dark:text-gray-400');
                tabs[0].classList.add('bg-white', 'dark:bg-gray-700', 'text-gray-900', 'dark:text-white', 'shadow-sm');
            }
            
            // Close all notifications modal
            function closeAllNotificationsModal() {
                const modal = document.getElementById('allNotificationsModal');
                if (modal) {
                    modal.classList.add('hidden');
                }
            }
            
            // Update all notifications modal content
            function updateAllNotificationsModal() {
                const notifications = getNotifications();
                const notificationsList = document.getElementById('allNotificationsList');
                const notificationsCount = document.getElementById('notificationsCount');
                
                if (!notificationsList || !notificationsCount) return;
                
                notificationsCount.textContent = notifications.length;
                
                if (notifications.length === 0) {
                    notificationsList.innerHTML = `
                        <div class="text-center py-12">
                            <span class="material-symbols-outlined text-6xl text-gray-300 dark:text-gray-600 mb-4 block">notifications_off</span>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No notifications</h3>
                            <p class="text-gray-500 dark:text-gray-400">You're all caught up!</p>
                        </div>
                    `;
                    return;
                }
                
                // Sort notifications by priority and timestamp
                const sortedNotifications = notifications.sort((a, b) => {
                    const priorityOrder = { critical: 4, high: 3, medium: 2, low: 1 };
                    if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                        return priorityOrder[b.priority] - priorityOrder[a.priority];
                    }
                    return new Date(b.timestamp) - new Date(a.timestamp);
                });
                
                // Group notifications by date
                const groupedNotifications = groupNotificationsByDate(sortedNotifications);
                
                notificationsList.innerHTML = Object.keys(groupedNotifications).map(date => {
                    const dayNotifications = groupedNotifications[date];
                    return `
                        <div class="mb-6">
                            <h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">${date}</h4>
                            <div class="space-y-3">
                                ${dayNotifications.map(notification => {
                                    const timeAgo = getTimeAgo(new Date(notification.timestamp));
                                    const priorityColor = getPriorityColor(notification.priority);
                                    const readClass = notification.read ? 'opacity-60' : '';
                                    
                                    return `
                                        <div class="notification-item-modal p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 cursor-pointer transition-colors ${readClass}" data-id="${notification.id}">
                                            <div class="flex items-start gap-4">
                                                <div class="flex-shrink-0">
                                                    <div class="w-10 h-10 rounded-full flex items-center justify-center ${priorityColor}">
                                                        <span class="material-symbols-outlined text-white text-lg">
                                                            ${getNotificationIcon(notification.type)}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <div class="flex items-start justify-between gap-3">
                                                        <div class="flex-1">
                                                            <h5 class="text-sm font-semibold text-gray-900 dark:text-white mb-1">
                                                                ${notification.title}
                                                            </h5>
                                                            <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">
                                                                ${notification.message}
                                                            </p>
                                                            <div class="flex items-center gap-2">
                                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${priorityColor} text-white">
                                                                    ${notification.priority.toUpperCase()}
                                                                </span>
                                                                <span class="text-xs text-gray-500 dark:text-gray-400">${timeAgo}</span>
                                                            </div>
                                                        </div>
                                                        <div class="flex items-center gap-2">
                                                            ${!notification.read ? '<div class="w-3 h-3 bg-primary rounded-full"></div>' : ''}
                                                            <button class="delete-notification-btn p-1 text-gray-400 hover:text-red-500 transition-colors" data-id="${notification.id}" title="Delete notification">
                                                                <span class="material-symbols-outlined text-sm">delete</span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Add event listeners
                setupAllNotificationsItemEvents();
            }
            
            // Group notifications by date
            function groupNotificationsByDate(notifications) {
                const groups = {};
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                notifications.forEach(notification => {
                    const date = new Date(notification.timestamp);
                    let groupKey;
                    
                    if (date.toDateString() === today.toDateString()) {
                        groupKey = 'Today';
                    } else if (date.toDateString() === yesterday.toDateString()) {
                        groupKey = 'Yesterday';
                    } else {
                        groupKey = date.toLocaleDateString('en-US', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                    }
                    
                    if (!groups[groupKey]) {
                        groups[groupKey] = [];
                    }
                    groups[groupKey].push(notification);
                });
                
                return groups;
            }
            
            // Setup event listeners for notification items in the modal
            function setupAllNotificationsItemEvents() {
                // Click to mark as read and highlight entry
                document.querySelectorAll('.notification-item-modal').forEach(item => {
                    item.addEventListener('click', function(e) {
                        if (e.target.closest('.delete-notification-btn')) return; // Don't trigger on delete button
                        
                        const notificationId = this.dataset.id;
                        markNotificationAsRead(notificationId);
                        
                        const notification = getNotificationById(notificationId);
                        if (notification && notification.entryId) {
                            highlightEntry(notification.entryId);
                            closeAllNotificationsModal();
                        }
                        
                        updateAllNotificationsModal();
                        updateNotificationBadge();
                    });
                });
                
                // Delete notification
                document.querySelectorAll('.delete-notification-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const notificationId = this.dataset.id;
                        deleteNotification(notificationId);
                        updateAllNotificationsModal();
                        updateNotificationBadge();
                    });
                });
            }
            
            // Filter notifications in the modal
            function filterAllNotifications(filter) {
                const notifications = getNotifications();
                let filteredNotifications = notifications;
                
                if (filter !== 'all') {
                    if (filter === 'unread') {
                        filteredNotifications = notifications.filter(n => !n.read);
                    } else {
                        filteredNotifications = notifications.filter(n => n.priority === filter);
                    }
                }
                
                // Update the display with filtered notifications
                updateAllNotificationsModalWithFilter(filteredNotifications);
            }
            
            // Update modal with filtered notifications
            function updateAllNotificationsModalWithFilter(filteredNotifications) {
                const notificationsList = document.getElementById('allNotificationsList');
                const notificationsCount = document.getElementById('notificationsCount');
                
                if (!notificationsList || !notificationsCount) return;
                
                notificationsCount.textContent = filteredNotifications.length;
                
                if (filteredNotifications.length === 0) {
                    notificationsList.innerHTML = `
                        <div class="text-center py-12">
                            <span class="material-symbols-outlined text-6xl text-gray-300 dark:text-gray-600 mb-4 block">notifications_off</span>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No notifications</h3>
                            <p class="text-gray-500 dark:text-gray-400">No notifications match this filter.</p>
                        </div>
                    `;
                    return;
                }
                
                // Sort and group filtered notifications
                const sortedNotifications = filteredNotifications.sort((a, b) => {
                    const priorityOrder = { critical: 4, high: 3, medium: 2, low: 1 };
                    if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                        return priorityOrder[b.priority] - priorityOrder[a.priority];
                    }
                    return new Date(b.timestamp) - new Date(a.timestamp);
                });
                
                const groupedNotifications = groupNotificationsByDate(sortedNotifications);
                
                notificationsList.innerHTML = Object.keys(groupedNotifications).map(date => {
                    const dayNotifications = groupedNotifications[date];
                    return `
                        <div class="mb-6">
                            <h4 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-3">${date}</h4>
                            <div class="space-y-3">
                                ${dayNotifications.map(notification => {
                                    const timeAgo = getTimeAgo(new Date(notification.timestamp));
                                    const priorityColor = getPriorityColor(notification.priority);
                                    const readClass = notification.read ? 'opacity-60' : '';
                                    
                                    return `
                                        <div class="notification-item-modal p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 cursor-pointer transition-colors ${readClass}" data-id="${notification.id}">
                                            <div class="flex items-start gap-4">
                                                <div class="flex-shrink-0">
                                                    <div class="w-10 h-10 rounded-full flex items-center justify-center ${priorityColor}">
                                                        <span class="material-symbols-outlined text-white text-lg">
                                                            ${getNotificationIcon(notification.type)}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <div class="flex items-start justify-between gap-3">
                                                        <div class="flex-1">
                                                            <h5 class="text-sm font-semibold text-gray-900 dark:text-white mb-1">
                                                                ${notification.title}
                                                            </h5>
                                                            <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">
                                                                ${notification.message}
                                                            </p>
                                                            <div class="flex items-center gap-2">
                                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${priorityColor} text-white">
                                                                    ${notification.priority.toUpperCase()}
                                                                </span>
                                                                <span class="text-xs text-gray-500 dark:text-gray-400">${timeAgo}</span>
                                                            </div>
                                                        </div>
                                                        <div class="flex items-center gap-2">
                                                            ${!notification.read ? '<div class="w-3 h-3 bg-primary rounded-full"></div>' : ''}
                                                            <button class="delete-notification-btn p-1 text-gray-400 hover:text-red-500 transition-colors" data-id="${notification.id}" title="Delete notification">
                                                                <span class="material-symbols-outlined text-sm">delete</span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Add event listeners
                setupAllNotificationsItemEvents();
            }
            
            // Delete a specific notification
            function deleteNotification(id) {
                const notifications = getNotifications();
                const filteredNotifications = notifications.filter(n => n.id !== id);
                localStorage.setItem(NOTIFICATIONS_KEY, JSON.stringify(filteredNotifications));
            }
            
            // Clear old notifications (older than 30 days)
            function clearOldNotifications() {
                const notifications = getNotifications();
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                const recentNotifications = notifications.filter(notification => {
                    return new Date(notification.timestamp) > thirtyDaysAgo;
                });
                
                localStorage.setItem(NOTIFICATIONS_KEY, JSON.stringify(recentNotifications));
                updateAllNotificationsModal();
                updateNotificationBadge();
            }
        });
    </script>

    <!-- MOU Details Modal -->
    <div id="mouDetailsModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden">
        <div class="w-full max-w-4xl bg-white dark:bg-background-dark rounded-xl shadow-2xl m-4 flex flex-col max-h-[90vh]">
            <!-- Modal Header -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-800 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 id="mouDetailsTitle" class="text-xl font-semibold text-gray-900 dark:text-white">MOU/MOA Details</h3>
                        <p id="mouDetailsSubtitle" class="text-sm text-gray-500 dark:text-gray-400 mt-1">Memorandum information</p>
                    </div>
                    <button id="closeMouDetails" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500 dark:text-gray-400">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6 flex-1 overflow-y-auto">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Left Column -->
                    <div class="space-y-6">
                        <div class="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary">business</span>
                                Institution Information
                            </h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Institution Name</label>
                                    <p id="detailInstitution" class="text-base text-gray-900 dark:text-white font-medium">-</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Location</label>
                                    <p id="detailLocation" class="text-base text-gray-900 dark:text-white">-</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Contact Details</label>
                                    <p id="detailContact" class="text-base text-gray-900 dark:text-white">-</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary">schedule</span>
                                Agreement Timeline
                            </h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Term Duration</label>
                                    <p id="detailTerm" class="text-base text-gray-900 dark:text-white">-</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Sign Date</label>
                                    <p id="detailSignDate" class="text-base text-gray-900 dark:text-white">-</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">End Date</label>
                                    <p id="detailEndDate" class="text-base text-gray-900 dark:text-white">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column -->
                    <div class="space-y-6">
                        <div class="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary">info</span>
                                Status Information
                            </h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Current Status</label>
                                    <span id="detailStatus" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium">-</span>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Days Until Expiry</label>
                                    <p id="detailDaysUntilExpiry" class="text-base text-gray-900 dark:text-white">-</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary">description</span>
                                Document Information
                            </h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Attached File</label>
                                    <div id="detailFileInfo" class="text-base text-gray-900 dark:text-white">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="p-6 bg-gray-50 dark:bg-background-dark/30 rounded-b-xl flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button id="editMouFromDetails" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-primary bg-primary/10 rounded-lg hover:bg-primary/20">
                            <span class="material-symbols-outlined text-sm">edit</span>
                            Edit MOU
                        </button>
                        <button id="viewFileFromDetails" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 bg-gray-100 dark:bg-gray-800 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 hidden">
                            <span class="material-symbols-outlined text-sm">visibility</span>
                            View File
                        </button>
                    </div>
                    <button id="closeMouDetailsBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-background-dark/50 dark:text-gray-300 dark:border-gray-700 dark:hover:bg-gray-800">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MOU Details Modal Functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mouDetailsModal = document.getElementById('mouDetailsModal');
            const closeMouDetails = document.getElementById('closeMouDetails');
            const closeMouDetailsBtn = document.getElementById('closeMouDetailsBtn');
            const editMouFromDetails = document.getElementById('editMouFromDetails');
            const viewFileFromDetails = document.getElementById('viewFileFromDetails');
            
            let currentMouData = null;
            
            // Function to show MOU details modal
            function showMouDetails(mouData) {
                currentMouData = mouData;
                
                // Update modal content
                document.getElementById('mouDetailsTitle').textContent = `${mouData.institution} - MOU/MOA Details`;
                document.getElementById('mouDetailsSubtitle').textContent = `Agreement with ${mouData.institution}`;
                
                // Fill in the details
                document.getElementById('detailInstitution').textContent = mouData.institution || '-';
                document.getElementById('detailLocation').textContent = mouData.location || '-';
                document.getElementById('detailContact').textContent = mouData.contact_email || 'No contact information';
                
                // Format term duration to always include proper unit
                let termText = mouData.term || '-';
                if (termText !== '-' && termText) {
                    // If it's just a number, add appropriate unit
                    if (/^\d+$/.test(termText.trim())) {
                        const number = parseInt(termText.trim());
                        termText = number === 1 ? '1 year' : number + ' years';
                    }
                    // If it already has a unit, keep it as is
                }
                document.getElementById('detailTerm').textContent = termText;
                
                document.getElementById('detailSignDate').textContent = mouData.sign_date ? formatDate(mouData.sign_date) : '-';
                document.getElementById('detailEndDate').textContent = mouData.end_date ? formatDate(mouData.end_date) : '-';
                
                // Update status with appropriate styling
                const statusElement = document.getElementById('detailStatus');
                statusElement.textContent = mouData.status || '-';
                
                // Remove existing status classes
                statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium';
                
                // Add status-specific classes
                if (mouData.status === 'Active') {
                    statusElement.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-900/50', 'dark:text-green-300');
                } else if (mouData.status === 'Expired') {
                    statusElement.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900/50', 'dark:text-red-300');
                } else if (mouData.status === 'Expires Soon') {
                    statusElement.classList.add('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-900/50', 'dark:text-yellow-300');
                } else {
                    statusElement.classList.add('bg-gray-100', 'text-gray-800', 'dark:bg-gray-900/50', 'dark:text-gray-300');
                }
                
                // Calculate days until expiry
                if (mouData.end_date) {
                    const today = new Date();
                    const endDate = new Date(mouData.end_date);
                    const daysUntilExpiry = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                    
                    let expiryText;
                    if (daysUntilExpiry < 0) {
                        expiryText = `Expired ${Math.abs(daysUntilExpiry)} days ago`;
                    } else if (daysUntilExpiry === 0) {
                        expiryText = 'Expires today';
                    } else if (daysUntilExpiry === 1) {
                        expiryText = 'Expires tomorrow';
                    } else {
                        expiryText = `${daysUntilExpiry} days remaining`;
                    }
                    
                    document.getElementById('detailDaysUntilExpiry').textContent = expiryText;
                } else {
                    document.getElementById('detailDaysUntilExpiry').textContent = '-';
                }
                
                // Handle file information
                const fileInfoElement = document.getElementById('detailFileInfo');
                const viewFileBtn = document.getElementById('viewFileFromDetails');
                
                if (mouData.file_name && mouData.file_path) {
                    fileInfoElement.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">description</span>
                            <span class="font-medium">${mouData.file_name}</span>
                        </div>
                    `;
                    viewFileBtn.classList.remove('hidden');
                    viewFileBtn.onclick = () => showFileViewer(mouData.file_path, mouData.file_name);
                } else {
                    fileInfoElement.textContent = 'No file attached';
                    viewFileBtn.classList.add('hidden');
                }
                
                // Local function to determine status
                function determineStatusLocal(endDate) {
                    if (!endDate) {
                        return 'Will be determined automatically';
                    }
                    
                    const today = new Date();
                    const endDateObj = new Date(endDate);
                    
                    // Set time to start of day for accurate comparison
                    today.setHours(0, 0, 0, 0);
                    endDateObj.setHours(0, 0, 0, 0);
                    
                    // Calculate days until expiry
                    const daysUntilExpiry = Math.ceil((endDateObj - today) / (1000 * 60 * 60 * 24));
                    
                    if (endDateObj < today) {
                        return 'Expired';
                    } else if (daysUntilExpiry <= 30) {
                        return 'Expires Soon';
                    } else {
                        return 'Active';
                    }
                }
                
                // Set up edit button with better error handling
                editMouFromDetails.onclick = () => {
                    console.log('Edit MOU button clicked for ID:', mouData.id);
                    
                    // Close the details modal first
                    mouDetailsModal.classList.add('hidden');
                    
                    // Small delay to ensure modal closes before opening edit modal
                    setTimeout(() => {
                        try {
                            // Get the entry data from localStorage
                            const entries = getAllEntries();
                            const entryToEdit = entries.find(entry => entry.id === mouData.id);
                            
                            if (!entryToEdit) {
                                console.error('Entry not found for ID:', mouData.id);
                                alert('Entry not found. Please refresh the page and try again.');
                                return;
                            }
                            
                            console.log('Found entry to edit:', entryToEdit);
                            
                            // Store the ID for editing
                            window.editingEntryId = mouData.id;
                            
                            // Pre-fill the modal with existing data
                            document.getElementById('institution').value = entryToEdit.institution || '';
                            document.getElementById('location').value = entryToEdit.location || '';
                            document.getElementById('contact').value = entryToEdit.contact_email || '';
                            document.getElementById('term').value = entryToEdit.term || '';
                            document.getElementById('sign-date').value = entryToEdit.sign_date || '';
                            document.getElementById('end-date').value = entryToEdit.end_date || '';
                            
                            // Update status display
                            const status = determineStatusLocal(entryToEdit.end_date);
                            const autoStatusText = document.getElementById('autoStatusText');
                            if (autoStatusText) {
                                autoStatusText.textContent = status;
                                
                                // Update text color based on status
                                if (status === 'Active') {
                                    autoStatusText.className = 'text-green-600 dark:text-green-400';
                                } else if (status === 'Expired') {
                                    autoStatusText.className = 'text-red-600 dark:text-red-400';
                                } else if (status === 'Expires Soon') {
                                    autoStatusText.className = 'text-yellow-600 dark:text-yellow-400';
                                } else {
                                    autoStatusText.className = 'text-gray-500 dark:text-gray-400';
                                }
                            }
                            
                            // Update modal title and button text
                            const modalTitle = document.querySelector('#addFileModal h3');
                            const saveBtn = document.getElementById('saveBtn');
                            if (modalTitle) modalTitle.textContent = 'Edit MOU/MOA File';
                            if (saveBtn) saveBtn.textContent = 'Update';
                            
                            // Show the edit modal
                            const modal = document.getElementById('addFileModal');
                            if (modal) {
                                modal.classList.remove('hidden');
                                console.log('Edit modal opened successfully');
                            } else {
                                console.error('Edit modal not found');
                                alert('Edit modal not found. Please refresh the page.');
                            }
                            
                        } catch (error) {
                            console.error('Error opening edit modal:', error);
                            alert('Error opening edit form: ' + error.message);
                        }
                    }, 100);
                };
                
                // Show modal
                mouDetailsModal.classList.remove('hidden');
            }
            
            // Function to format date
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            }
            
            // Close modal functions
            function closeMouDetailsModal() {
                mouDetailsModal.classList.add('hidden');
                currentMouData = null;
            }
            
            // Event listeners
            closeMouDetails.addEventListener('click', closeMouDetailsModal);
            closeMouDetailsBtn.addEventListener('click', closeMouDetailsModal);
            
            // Close modal when clicking outside
            mouDetailsModal.addEventListener('click', function(e) {
                if (e.target === mouDetailsModal) {
                    closeMouDetailsModal();
                }
            });
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && mouDetailsModal && !mouDetailsModal.classList.contains('hidden')) {
                    closeMouDetailsModal();
                }
            });
            
            // Make showMouDetails globally accessible
            window.showMouDetails = showMouDetails;
            
            // Add click event listeners to table rows
            function addRowClickListener(row, mouData) {
                row.addEventListener('click', function(e) {
                    // Don't trigger if clicking on buttons, checkboxes, or links
                    if (e.target.tagName === 'BUTTON' || 
                        e.target.tagName === 'INPUT' || 
                        e.target.tagName === 'A' ||
                        e.target.closest('button') ||
                        e.target.closest('input') ||
                        e.target.closest('a')) {
                        return;
                    }
                    
                    // Show MOU details
                    showMouDetails(mouData);
                });
            }
            
            // Make addRowClickListener globally accessible
            window.addRowClickListener = addRowClickListener;
        });
    </script>

</body></html>



